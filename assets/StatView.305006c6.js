import{a as Q}from"./vue-router.fb15f89e.js";import{d as x,a as X}from"./dayjs.386643b6.js";import{_ as P}from"./DateTime.vue_vue_type_script_setup_true_lang.5b996069.js";import{m as R,r as y,d as _,o as W,S as Z,w as j,J as H,q as Y,t as S,v as u,z as T,G as D,F as ee,E as te,u as b,k as V,P as se,Q as ae,n as ne,U as oe,A as B,R as re,B as A,X as le,Y as U}from"./@vue.4058792e.js";import{_ as ie,i as ce,B as N,u as G,m as ue,g as de,t as me,d as pe,e as fe,E as ve}from"./index.b4e5147c.js";import{a as he}from"./@vueuse.0eb3a410.js";import{u as xe,i as ye,a as ge,b as _e,c as we,d as $e,e as Me,f as Ce,g as Ye,h as ke,j as be,k as De,l as Se}from"./echarts.f6f9045b.js";import{_ as q}from"./Select.vue_vue_type_style_index_0_lang.44a40136.js";import{u as Te}from"./useLimitSelect.8881ae61.js";import{s as Ie}from"./mathjs.71232648.js";import{r as Ve}from"./lodash-es.4471eccc.js";import"./complex.js.3b936b7b.js";import"./dexie.a92c4e2b.js";import"./uuid.fbc3d34b.js";import"./vue-i18n.5e152601.js";import"./@intlify.02a09968.js";import"./zrender.271abeed.js";import"./decimal.js.f8235747.js";import"./typed-function.0cf4a37b.js";import"./@babel.9ebe5c4e.js";import"./fraction.js.f0253b53.js";const Ne=o=>(se("data-v-58ed6b73"),o=o(),ae(),o),Ee={class:"flex flex-col items-center"},je={class:"flex justify-around rounded-full items-center max-w-300px w-full"},Re=["onClick"],Be={key:1,class:"flex justify-around items-center w-full h-12"},Ae=Ne(()=>u("div",null,"-",-1)),Oe=R({__name:"DateRangeSelector",props:{start:{default:x().format("YYYY-MM-DD")},end:{default:x().format("YYYY-MM-DD")},date:null,initialType:{default:"month"}},emits:["change"],setup(o,{emit:a}){const s=o,r=()=>{const m=x(s.start).startOf("year"),d=x(s.end).startOf("year"),c=m.year(),i=d.year();return{type:"year",times:Array.from({length:Math.abs(i-c)+1},(l,f)=>({name:`${c+f}`,range:[x(`${c+f}`),x(`${c+f}`).endOf("year")]}))}},t=()=>{const m=x(s.end).startOf("month"),d=x(s.start).startOf("month"),c=Math.abs(m.diff(d,"month"))+1,i=Array.from({length:c},(l,f)=>{const C=d.add(f,"month");return{name:C.format("YYYY-MM"),range:[C,C.endOf("month")]}});return{type:"month",times:i}},e=y(s.initialType),n=_(()=>e.value==="year"?r().times:e.value==="month"?t().times:[{name:"",range:[x(s.start),x(s.end)]}]),v=y(),h=m=>{var i;const d=x(m),c=[...n.value].reverse().findIndex(l=>d.isAfter(l.range[0]));return{index:c,time:(i=n.value[c])!=null?i:n.value[0]}},w=y(),M=y(x(s.start)),p=y(x(s.end)),g=()=>{const{index:m,time:d}=h(M.value);k(d,m,!1)};W(()=>{g()});const $=y();Z(()=>{$.value!==void 0&&$.value.scrollIntoView({block:"center",inline:"center",behavior:void 0})}),j(e,m=>{m!=="custom"&&ne(()=>{g()})});const k=(m,d,c=!0)=>{var i;w.value=m,v.value&&((i=document.querySelector(`.slider-item-${d}`))==null||i.scrollIntoView({block:"center",inline:"center",behavior:c?"smooth":void 0})),a("change",...w.value.range)};return H(()=>{M.value&&p.value&&a("change",M.value,p.value)}),(m,d)=>(Y(),S("div",Ee,[u("div",je,[u("div",{class:T(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="year"}]),onClick:d[0]||(d[0]=c=>e.value="year")},D(m.$t("year")),3),u("div",{class:T(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="month"}]),onClick:d[1]||(d[1]=c=>e.value="month")},D(m.$t("month")),3),u("div",{class:T(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="custom"}]),onClick:d[2]||(d[2]=c=>e.value="custom")},D(m.$t("custom")),3)]),e.value!=="custom"?(Y(),S("div",{class:"slider w-full h-12 flex items-center overflow-x-scroll snap snap-always snap-mandatory snap-x",key:e.value,ref_key:"sliderEl",ref:v},[(Y(!0),S(ee,null,te(b(n),(c,i)=>{var l;return Y(),S("div",{key:c.name,class:T(["slider-item whitespace-nowrap mx-2 px-2 rounded-sm snap-center text-sm",[{"bg-stone-700 text-white":c.name===((l=w.value)==null?void 0:l.name)},`slider-item-${i}`]]),ref_for:!0,ref:f=>{var C;return c.name===((C=w.value)==null?void 0:C.name)?$.value=f:void 0},onClick:f=>k(c,i)},D(c.name),11,Re)}),128))])):(Y(),S("div",Be,[V(P,{modelValue:M.value,"onUpdate:modelValue":d[3]||(d[3]=c=>M.value=c),"display-formatter":"YYYY-MM-DD",class:"text-sm buttoned rounded px-2"},null,8,["modelValue"]),Ae,V(P,{modelValue:p.value,"onUpdate:modelValue":d[4]||(d[4]=c=>p.value=c),"display-formatter":"YYYY-MM-DD",class:"text-sm buttoned rounded px-2"},null,8,["modelValue"])]))]))}});const Ue=ie(Oe,[["__scopeId","data-v-58ed6b73"]]);xe([ye,ge,_e,we,$e,Me,Ce,Ye,ke,be,De]);const z=R({__name:"Chart",props:{option:null,onClick:null},emits:["click"],setup(o,{emit:a}){const s=o,r=y(),{width:t}=he();return W(()=>{const e=Se(r.value);e.setOption(s.option),j(()=>s.option,()=>{e.setOption(s.option)}),oe(()=>{e.dispose()}),j(t,()=>{e.resize()}),e.on("click",n=>{a("click",n)})}),(e,n)=>(Y(),S("div",{ref_key:"chartRef",ref:r},null,512))}}),E=o=>{let a=0;try{let t=Number(o).toString().toUpperCase();if(t.split("E").length===2){var s=!1;t.split(".").length===2&&(t=t.split(".")[1],parseInt(t.split("E")[0])!==0&&(s=!0));let e=t.split("E");s&&(a=e[0].length),a-=parseInt(e[1])}else t.split(".").length===2&&parseInt(t.split(".")[1])!==0&&(a=t.split(".")[1].length)}catch(r){throw r}finally{return(isNaN(a)||a<0)&&(a=0),a}},F=o=>{let a=Number(o),s=E(o),r=o.toString().toUpperCase();return r.split("E").length===2?a=Math.round(a*Math.pow(10,s)):a=Number(r.replace(".","")),a},K=(o,a,s,r)=>{let t=0;switch(o){case"add":t=a+s;break;case"sub":t=a-s;break;case"div":t=a/s;break;case"mul":t=a*s;break}return Math.abs(r-t)>1?t:r},J=(o,a)=>{const s=Number(o),r=Number(a);var t=0,e=s.toString(),n=r.toString();try{t+=E(e)}catch{}try{t+=E(n)}catch{}var v=F(e)*F(n)/Math.pow(10,t);return K("mul",s,r,v)},I=(o,a)=>{const s=Number(o),r=Number(a);let t,e,n;try{t=E(s)+1}catch{t=0}try{e=E(r)+1}catch{e=0}n=Math.pow(10,Math.max(t,e));var v=(J(s,n)+J(r,n))/n;return K("add",s,r,v)},{list:Le}=G();x.extend(X);const Pe=["income","expenses","sum"],qe=(o,a)=>{const s=_(()=>Le.value.filter(e=>ce(e,o.value,a.value))),r=_(()=>!o.value||!a.value?"YYYY-MM-DD":x.duration(a.value.diff(o.value)).asDays()>=364?"YYYY-MM":"YYYY-MM-DD");return _(()=>{const e=new Map;return s.value.forEach(n=>{var g,$,k,m;const v=x.unix(n.time).format(r.value),h=(()=>(e.has(n.creatorId)||e.set(n.creatorId,{expenses:new Map,income:new Map,sum:new Map,incomeCategories:new Map,expenseCategories:new Map}),e.get(n.creatorId)))(),w=h.sum;w.set(v,n.type===N.Expenses?I((g=w.get(v))!=null?g:0,n.money):Ie(($=w.get(v))!=null?$:0,n.money));const M=n.type===N.Expenses?h.expenses:h.income;M.set(v,I((k=M.get(v))!=null?k:0,n.money));const p=n.type===N.Expenses?h.expenseCategories:h.incomeCategories;p.set(n.categoryId,I((m=p.get(n.categoryId))!=null?m:0,n.money))}),e})},O=(o,a,s)=>{if(s==="sum")return a.filter(e=>o.has(e.id)).map(e=>({total:[...o.get(e.id).sum.values()].reduce((v,h)=>v+h,0),name:e.name,category:e.name}));const r=a.filter(e=>o.has(e.id)).map(e=>{switch(s){case"expenses":return o.get(e.id).expenseCategories;case"income":return o.get(e.id).incomeCategories;default:return o.get(e.id).expenseCategories}}).flat();return[...ue(...r).entries()].map(([e,n])=>{const v=de(e);return{total:n,name:v.name,category:me(v.name)}})},ze=(o,a,s)=>({values:a.filter(t=>o.has(t.id)).map(t=>({data:[...o.get(t.id)[s].entries()],user:t}))}),Fe={class:"w-full px-2 flex flex-col items-center"},Je={class:"flex items-center shadow-inner rounded-full p-1"},We=u("div",{class:"transform translate-y-[-30%]"},[u("i",{class:"icon-chart icon-xs"})],-1),Ge=[We],Ke=u("div",{class:"transform translate-y-[30%]"},[u("i",{class:"icon-trending icon-xs"})],-1),Qe=[Ke],Xe={class:"flex w-full px-2 items-center justify-between"},Ze={class:"shadow buttoned px-4 max-w-[160px] rounded-full h-full truncate mx-2 py-1 flex items-center"},He=u("i",{class:"icon-smile-no-mouth icon-xs"},null,-1),et={class:"px-2"},tt={class:"flex items-center"},st={class:"rounded buttoned h-full truncate flex items-center px-2"},at=u("div",{class:"pr-2"},[u("i",{class:"icon-arrows-exchange-alt-v icon-xs"})],-1),nt=R({__name:"IncomeChart",props:{statistic:null},setup(o,{expose:a}){const s=o,r=y("expenses"),t=y([]),{allUsers:e}=pe();Te(t,e);const n=y("pie"),v=_(()=>O(s.statistic,t.value,"expenses")),h=_(()=>O(s.statistic,t.value,"income")),w=_(()=>O(s.statistic,t.value,"sum")),M=_(()=>({expenses:v.value.reduce((i,l)=>I(i,l.total),0),income:h.value.reduce((i,l)=>I(i,l.total),0),sum:w.value.reduce((i,l)=>I(i,l.total),0)})),p=_(()=>{switch(r.value){case"expenses":return v.value;case"income":return h.value;case"sum":return w.value;default:return[]}}),g=y(""),$=y(""),k=i=>{i.data&&(g.value=`${i.data.category}: ${i.data.total}`,$.value=i.data.name)};j(r,()=>{g.value="",$.value=""}),a({currentCategory:$,currentType:r,selectedUsers:t});const m=_(()=>({dataset:{dimensions:["category","total"],source:le(p.value)},tooltip:{show:!0,formatter:l=>`${l.name}: ${l.value.total}`},xAxis:{type:"category",show:!1},yAxis:{},series:[{type:"pie",radius:["50%","70%"],stillShowZeroSum:!1,itemStyle:{color(l){var f,C;return(C=(f=fe.find(L=>L.name===l.data.name))==null?void 0:f.pieColor)!=null?C:""},borderRadius:5,borderWidth:2,borderColor:"white"}}]})),d=_(()=>ze(s.statistic,e.value,r.value)),c=_(()=>({xAxis:{type:"time"},yAxis:{type:"value"},tooltip:{show:!0,formatter:l=>`${l.seriesName}: ${l.value[1]}`},series:d.value.values.map(({data:l,user:f})=>({data:Ve(l),type:"line",name:f.name}))}));return(i,l)=>(Y(),S("div",Fe,[u("div",Je,[u("div",{class:T(["flex justify-center items-center w-12 h-6 rounded-full",{"bg-stone-700 text-white":n.value==="pie"}]),onClick:l[0]||(l[0]=f=>n.value="pie")},Ge,2),u("div",{class:T(["flex justify-center items-center w-12 h-6 rounded-full",{"bg-stone-700 text-white":n.value==="line"}]),onClick:l[1]||(l[1]=f=>n.value="line")},Qe,2)]),(Y(),B(re,null,[n.value==="pie"?(Y(),B(z,{key:0,class:"w-full aspect-square max-h-300px",option:b(m),onClick:k},null,8,["option"])):(Y(),B(z,{key:1,class:"w-full aspect-square max-h-300px",option:b(c)},null,8,["option"]))],1024)),u("div",Xe,[V(q,{modelValue:t.value,"onUpdate:modelValue":l[2]||(l[2]=f=>t.value=f),list:b(e),multiple:"","value-key":"id",placement:"bottom-left"},{default:A(({allSelected:f})=>[u("div",Ze,[He,u("div",et,D(f?i.$t("all"):t.value.length===0?"None":t.value.map(C=>C.name).join(",")),1)])]),_:1},8,["modelValue","list"]),u("div",tt,[V(q,{modelValue:r.value,"onUpdate:modelValue":l[3]||(l[3]=f=>r.value=f),list:b(Pe)},{option:A(({item:f})=>[U(D(i.$t(f)),1)]),default:A(()=>[u("div",st,[at,U(" "+D(i.$t(r.value))+": ",1)])]),_:1},8,["modelValue","list"]),u("div",null,D(b(M)[r.value]),1)])])]))}}),ot={class:"w-full h-full flex justify-center"},rt={class:"h-full w-full mx-2 max-w-[600px] flex flex-col items-center"},lt={class:"filter w-full m-1 p-2"},it={class:"w-full"},ct={class:"flex p-2 justify-end items-center"},ut=u("div",{class:"flex items-center justify-center"},[u("i",{class:"icon-chevron-right"})],-1),Vt=R({__name:"StatView",setup(o){const{list:a}=G(),s=_(()=>{const p=a.value.at(-1);if(p)return x.unix(p.time)}),r=_(()=>{const p=a.value.at(0);if(p)return x.unix(p.time)}),t=y(),e=y(),n=(p,g)=>{t.value=p,e.value=g},v=qe(t,e),h=y(),w=Q(),M=()=>{var k;const{selectedUsers:p,currentType:g,currentCategory:$}=(k=h.value)!=null?k:{};w.push({name:"search",query:{filters:JSON.stringify({type:g==="expenses"?N.Expenses:g==="income"?N.Income:void 0,users:p==null?void 0:p.map(m=>m.id),categories:$?[$].map(m=>{var d;return(d=ve.find(c=>c.name===m))==null?void 0:d.id}):void 0,start:t.value,end:e.value})}})};return(p,g)=>(Y(),S("div",ot,[u("div",rt,[u("div",lt,[V(Ue,{start:b(s),end:b(r),onChange:n},null,8,["start","end"])]),u("div",it,[V(nt,{ref_key:"chartRef",ref:h,statistic:b(v)},null,8,["statistic"])]),u("div",ct,[u("div",{class:"flex buttoned rounded-full py-1 px-2 flex items-center",onClick:M},[U(D(p.$t("see-details"))+" ",1),ut])])])]))}});export{Vt as default};
