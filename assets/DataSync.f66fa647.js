var z=Object.defineProperty;var G=(o,i,e)=>i in o?z(o,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[i]=e;var T=(o,i,e)=>(G(o,typeof i!="symbol"?i+"":i,e),e);import{m as O,q as w,A as Z,B as K,v as c,G as E,t as b,k as S,r as g,R as ee,c as te,u as R,F as ne,E as se,Z as oe,_ as ce}from"./@vue.6b771be9.js";import{c as U,i as Y}from"./cancelablePromise.8984d70f.js";import{$ as B}from"./peerjs.faff7497.js";import{k as ae,n as A,t as h,o as P,p as _,M as v,d as W,q as ie}from"./index.9baf700f.js";import{U as re}from"./UserAvatar.717f78af.js";import{d as D}from"./dayjs.386643b6.js";import"./peerjs-js-binarypack.edcf3dbb.js";import"./webrtc-adapter.37c3a6f1.js";import"./rtcpeerconnection-shim.1d74cdf3.js";import"./sdp.c10b5003.js";import"./vue-router.c17ffd82.js";import"./dexie.a92c4e2b.js";import"./uuid.fbc3d34b.js";import"./@vueuse.3609b986.js";import"./vue-i18n.a532ecf1.js";import"./@intlify.03657722.js";import"./complex.js.3b936b7b.js";const de=(()=>{let o=0;return()=>(o+=1,o)})(),le="DATA_SENDED",ue="DATA_ABORTED",pe="DATA_NEXT_RECEIVED";class V extends EventTarget{constructor(e,n){super();T(this,"receivingCallback");this.connection=e,this.info=n,this.connection.on("data",s=>{var l;const t=s;switch(t.type){case 0:this.connection.send({type:2,data:t.id}),this.dispatchEvent(new CustomEvent(pe,{detail:s})),(l=this.receivingCallback)==null||l.call(this,()=>t.data);break;case 2:this.dispatchEvent(new CustomEvent(le,{detail:s}));break;case 1:this.dispatchEvent(new CustomEvent(ue,{detail:s}));break}})}send(e){return U(n=>new Promise((s,t)=>{const l=de();this.connection.send({type:0,data:e,id:l});let m=!1;n(()=>{this.connection.send({type:1,data:l}),m=!0});const d=u=>{if(m){t();return}u.type===2&&u.data===l&&(s(),this.connection.off("data",d)),u.type===1&&u.data===l&&(t(),this.connection.off("data",d))};this.connection.on("data",d);const r=()=>{t(),this.connection.off("error",r)};this.connection.on("error",r)}))}close(){this.connection.close()}reject(){this.connection.send({type:1}),this.connection.close()}onReceiving(e){this.receivingCallback=e}nextReceived(){return new Promise((e,n)=>{const s=t=>{t.type===0&&(e(t.data),this.connection.off("data",s)),t.type===1&&(n(),this.connection.off("data",s))};this.connection.on("data",s)})}}const L="CONNECTION_REQUEST",M="CONNECTION_ACCEPTED",I="CONNECTION_REJECT_ERROR",q="ERROR_CONNECTION_CANCELED",F="EVENT_USER_ACCEPT",j="EVENT_USER_REJECT",me="EVENT_SENDER_CANCEL",fe=o=>(o==null?void 0:o.message)===I,ye=o=>(o==null?void 0:o.message)===q;class x extends EventTarget{constructor(e,n){super();T(this,"peer");T(this,"connectionCallback");this.meta=e,this.peer=n?new B(n):new B,this.setPeer()}notifyUpdate(){this.dispatchEvent(new CustomEvent("update",{detail:this.save()}))}static fromStore(e,n){return n?new x(e,n.peerId):new x(e)}save(){return{peerId:this.peer.id}}connect(e){return U(n=>{let s,t;return n(()=>{s==null||s.close(),t==null||t.close()}),new Promise((m,d)=>{t=this.peer.connect(e,{metadata:{...this.meta,connectId:this.peer.id}}),t.once("open",()=>{t.send(L);const r=u=>{u.type===M&&(s=new V(t,{sender:{...this.meta,connectId:this.peer.id},receiver:{...u.metadata,connectId:e}}),m(s)),u.type===I&&d()};t.once("data",r)}),t.once("close",()=>d(new Error(I))),t.once("error",d)})})}disconnect(e){var n;(n=this.peer.getConnection(this.peer.id,e))==null||n.close()}onConnection(e){this.connectionCallback=e}setPeer(){this.peer.on("open",()=>{this.notifyUpdate(),this.dispatchEvent(new CustomEvent("ready"));const e=()=>new Promise((s,t)=>{this.addEventListener(F,()=>{s()},{once:!0}),this.addEventListener(j,()=>{t()},{once:!0}),this.addEventListener(me,()=>{t()},{once:!0})});let n;this.peer.on("connection",async s=>{var r;let t=!1;s.once("close",()=>{t=!0});const l=e();s.once("data",async u=>{if(u===L)try{await l,t||(n=new V(s,{sender:{...this.meta,connectId:this.peer.id},receiver:{...s.metadata}}))}catch{s.send({type:I}),s.close()}});const m=async()=>{if(this.dispatchEvent(new CustomEvent(F)),await l,t)throw t=!1,new Error(q);return s.send({type:M,metadata:{...this.meta,connectId:this.peer.id}}),n},d=()=>{this.dispatchEvent(new CustomEvent(j)),t=!1};(r=this.connectionCallback)==null||r.call(this,s.metadata,m,d)})})}destroy(){this.peer.destroy()}}const he={class:"p-4 flex flex-col w-full h-full items-center"},Ee={class:"flex-1 flex items-center"},_e=c("div",null,[c("i",{class:"icon-spinner"})],-1),ve={class:"px-2"},Ce=O({__name:"SyncDialog",props:{syncing:{type:Boolean}},emits:["cancel"],setup(o,{emit:i}){const e=async()=>{await A({title:h("are-you-sure-to-cancel-syncing")}),i("cancel")};return(n,s)=>(w(),Z(ae,{visible:o.syncing,"custom-class":"sync-status-dialog"},{default:K(()=>[c("div",he,[c("div",Ee,[_e,c("div",ve,E(n.$t("syncing")),1)]),c("button",{class:"buttoned px-4 py-2 rounded",onClick:e},E(n.$t("cancel")),1)])]),_:1},8,["visible"]))}});const we={class:"flex justify-between items-center"},Te={class:"flex items-center"},be={class:"flex flex-col justify-between px-2"},Ie={class:"text-xs text-stone-600"},xe={class:"flex items-center"},Ne={class:"mx-1"},$e=["disabled"],ge={class:"mx-1 flex items-center"},Re=c("i",{class:"icon-close"},null,-1),Se=[Re],Ae=O({__name:"SyncUser",props:{name:null,latestUpdate:null,autoSync:{type:Boolean},disabled:{type:Boolean}},emits:["sync","delete","update:autoSync"],setup(o){const i=e=>!e||e<0?h("not-sync"):D.unix(e).format("YYYY-MM-DD HH:mm:ss");return(e,n)=>(w(),b("div",we,[c("div",Te,[S(re,{name:o.name,size:"40px"},null,8,["name"]),c("div",be,[c("div",null,E(Boolean(o.name)?o.name:"untitled"),1),c("div",Ie,E(e.$t("last-sync"))+E(i(o.latestUpdate)),1)])]),c("div",xe,[c("div",Ne,[c("button",{class:"buttoned shadow px-2 rounded cursor-not-allowed opacity-50 not-disabled:cursor-pointer not-disabled:opacity-100",disabled:o.disabled,onClick:n[0]||(n[0]=s=>e.$emit("sync"))},E(e.$t("sync")),9,$e)]),c("div",ge,[c("button",{class:"rounded buttoned",onClick:n[1]||(n[1]=s=>e.$emit("delete"))},Se)])])]))}}),{addUserInfo:De,allUsers:Oe,updateUserInfo:Ue}=W(),J=(o,i=!1)=>U(async e=>{try{const{receiver:n}=o.info,s=await P.bills.toArray(),{start:t,cancel:l}=o.send(s);e(l);const m=await(async()=>{if(i){const r=await o.nextReceived();return await t(),r}else{const[r,u]=await Promise.all([t(),o.nextReceived()]);return u}})(),d=Oe.value.find(r=>r.connectId===n.connectId);d?await Ue(d.id,{name:n.name,latestTransferTime:D().unix(),connectId:n.connectId}):await De({id:n.userId,name:n.name,latestTransferTime:D().unix(),connectId:n.connectId}),await P.addNewBillTable(n.userId,m),await new Promise(r=>setTimeout(()=>{r()},500)),o.close(),_({type:v.Success,content:h("sync-success")})}catch(n){Y(n)||_({type:v.Error,content:h("something-wrong-please-try-again")})}}),ke=async o=>navigator.clipboard.writeText(o),Be={class:"flex flex-col divide-y"},Pe={class:"flex flex-col items-center py-2 pb-4"},Ve={class:"py-2"},Le={class:"flex justify-center"},Me={class:"allow-select ml-2 px-2 bg-stone-200 rounded flex items-center text-center text-sm text-stone-800"},Fe=c("i",{class:"icon-copy"},null,-1),je=[Fe],Je={class:"pb-4"},Ye={class:"p-2 pb-4"},We={class:"flex justify-center py-2"},qe={class:"md:w-[80%] flex pt-2"},He=["placeholder"],Qe=["disabled"],mt=O({__name:"DataSync",setup(o){const{userInfo:i,allUsers:e,setMyInfo:n,removeUserInfo:s}=W(),t=x.fromStore({name:i.value.name,userId:i.value.id},{peerId:i.value.connectId});t.addEventListener("update",a=>{const f=a.detail;n({connectId:f.peerId})});const l=g(!1);t.addEventListener("ready",()=>{l.value=!0}),ee(()=>{t.destroy()});const m=te(()=>e.value.filter(({me:a})=>!a).map(a=>({connectId:a.connectId,latestTransferTime:a.latestTransferTime,meta:{name:a.name,userId:a.id}})));let d;const r=g(!1),u=async a=>{const{start:f,cancel:p}=t.connect(a);d=p,r.value=!0;try{const y=await f(),{start:N,cancel:$}=J(y);d=$,await N()}catch(y){Y(y)||fe(y)&&_({type:v.Error,content:h("connection-rejected")})}r.value=!1},k=()=>{d==null||d(),r.value=!1},C=g(""),H=()=>{C.value&&m.value.every(a=>a.connectId!==C.value)&&u(C.value)},Q=async a=>{await A({title:h("are-you-sure-to-delete-this-will-delete-all-record-created-by-the-user")}),await ie(a),await s(a),_({content:h("delete-user-success"),type:v.Success})};t.onConnection(async(a,f,p)=>{try{await A({title:`${a.name} ${h("wants-to-sync-data-with-you-accepted")}`}),r.value=!0;const y=await f(),{start:N,cancel:$}=J(y,!0);d=$,await N()}catch(y){if(ye(y)){_({type:v.Warning,content:h("connection-was-canceled")});return}p()}r.value=!1});const X=async a=>{!a||(await ke(a),_({content:h("copy-code-successfully"),type:v.Success}))};return(a,f)=>(w(),b("div",Be,[c("div",Pe,[c("div",Ve,E(a.$t("your-code")),1),c("div",Le,[c("div",Me,E(R(i).connectId),1),c("button",{class:"buttoned rounded mx-1 px-4 py-2",onClick:f[0]||(f[0]=p=>X(R(i).connectId))},je)])]),c("div",Je,[c("div",Ye,E(a.$t("shared-users")),1),(w(!0),b(ne,null,se(R(m),p=>(w(),b("div",{key:p.connectId,class:"p-2"},[S(Ae,{name:p.meta.name,"latest-update":p.latestTransferTime,"auto-sync":!1,disabled:!l.value,onSync:y=>u(p.connectId),onDelete:y=>Q(p.meta.userId)},null,8,["name","latest-update","disabled","onSync","onDelete"])]))),128))]),c("div",We,[c("div",qe,[oe(c("input",{"onUpdate:modelValue":f[1]||(f[1]=p=>C.value=p),placeholder:a.$t("paste-your-friends-code-here"),class:"border border-stone-600 rounded h-full px-1 mr-1 flex-1"},null,8,He),[[ce,C.value]]),c("button",{class:"not-disabled:bg-stone-900 text-white rounded px-2 py-1 bg-stone-200",disabled:!l.value,onClick:H},E(a.$t("add-friends")),9,Qe)])]),S(Ce,{syncing:r.value,onCancel:k},null,8,["syncing"])]))}});export{mt as default};
