import{b as V}from"./peerjs-js-binarypack.edcf3dbb.js";import{a as W}from"./webrtc-adapter.37c3a6f1.js";function w(i,r,e,t){Object.defineProperty(i,r,{get:e,set:t,enumerable:!0,configurable:!0})}var z=W.default||W,$=new(function(){function i(){this.isIOS=["iPad","iPhone","iPod"].includes(navigator.platform),this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}return i.prototype.isWebRTCSupported=function(){return typeof RTCPeerConnection<"u"},i.prototype.isBrowserSupported=function(){var r=this.getBrowser(),e=this.getVersion(),t=this.supportedBrowsers.includes(r);return t?r==="chrome"?e>=this.minChromeVersion:r==="firefox"?e>=this.minFirefoxVersion:r==="safari"?!this.isIOS&&e>=this.minSafariVersion:!1:!1},i.prototype.getBrowser=function(){return z.browserDetails.browser},i.prototype.getVersion=function(){return z.browserDetails.version||0},i.prototype.isUnifiedPlanSupported=function(){var r=this.getBrowser(),e=z.browserDetails.version||0;if(r==="chrome"&&e<this.minChromeVersion)return!1;if(r==="firefox"&&e>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;var t,n=!1;try{t=new RTCPeerConnection,t.addTransceiver("audio"),n=!0}catch{}finally{t&&t.close()}return n},i.prototype.toString=function(){return`Supports:
    browser:`.concat(this.getBrowser(),`
    version:`).concat(this.getVersion(),`
    isIOS:`).concat(this.isIOS,`
    isWebRTCSupported:`).concat(this.isWebRTCSupported(),`
    isBrowserSupported:`).concat(this.isBrowserSupported(),`
    isUnifiedPlanSupported:`).concat(this.isUnifiedPlanSupported())},i}()),Y={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},fe=function(){function i(){this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.chunkedMTU=16300,this.defaultConfig=Y,this.browser=$.getBrowser(),this.browserVersion=$.getVersion(),this.supports=function(){var r={browser:$.isBrowserSupported(),webRTC:$.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!r.webRTC)return r;var e;try{e=new RTCPeerConnection(Y),r.audioVideo=!0;var t=void 0;try{t=e.createDataChannel("_PEERJSTEST",{ordered:!0}),r.data=!0,r.reliable=!!t.ordered;try{t.binaryType="blob",r.binaryBlob=!$.isIOS}catch{}}catch{}finally{t&&t.close()}}catch{}finally{e&&e.close()}return r}(),this.pack=V.pack,this.unpack=V.unpack,this._dataCount=1}return i.prototype.noop=function(){},i.prototype.validateId=function(r){return!r||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(r)},i.prototype.chunk=function(r){for(var e=[],t=r.size,n=Math.ceil(t/p.chunkedMTU),o=0,a=0;a<t;){var s=Math.min(t,a+p.chunkedMTU),c=r.slice(a,s),l={__peerData:this._dataCount,n:o,data:c,total:n};e.push(l),a=s,o++}return this._dataCount++,e},i.prototype.blobToArrayBuffer=function(r,e){var t=new FileReader;return t.onload=function(n){n.target&&e(n.target.result)},t.readAsArrayBuffer(r),t},i.prototype.binaryStringToArrayBuffer=function(r){for(var e=new Uint8Array(r.length),t=0;t<r.length;t++)e[t]=r.charCodeAt(t)&255;return e.buffer},i.prototype.randomToken=function(){return Math.random().toString(36).slice(2)},i.prototype.isSecure=function(){return location.protocol==="https:"},i}(),p=new fe,ie={};w(ie,"Peer",()=>oe,i=>oe=i);var D={},de=Object.prototype.hasOwnProperty,g="~";function x(){}Object.create&&(x.prototype=Object.create(null),new x().__proto__||(g=!1));function pe(i,r,e){this.fn=i,this.context=r,this.once=e||!1}function ae(i,r,e,t,n){if(typeof e!="function")throw new TypeError("The listener must be a function");var o=new pe(e,t||i,n),a=g?g+r:r;return i._events[a]?i._events[a].fn?i._events[a]=[i._events[a],o]:i._events[a].push(o):(i._events[a]=o,i._eventsCount++),i}function R(i,r){--i._eventsCount===0?i._events=new x:delete i._events[r]}function v(){this._events=new x,this._eventsCount=0}v.prototype.eventNames=function(){var r=[],e,t;if(this._eventsCount===0)return r;for(t in e=this._events)de.call(e,t)&&r.push(g?t.slice(1):t);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r};v.prototype.listeners=function(r){var e=g?g+r:r,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var n=0,o=t.length,a=new Array(o);n<o;n++)a[n]=t[n].fn;return a};v.prototype.listenerCount=function(r){var e=g?g+r:r,t=this._events[e];return t?t.fn?1:t.length:0};v.prototype.emit=function(r,e,t,n,o,a){var s=g?g+r:r;if(!this._events[s])return!1;var c=this._events[s],l=arguments.length,f,d;if(c.fn){switch(c.once&&this.removeListener(r,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,t),!0;case 4:return c.fn.call(c.context,e,t,n),!0;case 5:return c.fn.call(c.context,e,t,n,o),!0;case 6:return c.fn.call(c.context,e,t,n,o,a),!0}for(d=1,f=new Array(l-1);d<l;d++)f[d-1]=arguments[d];c.fn.apply(c.context,f)}else{var O=c.length,E;for(d=0;d<O;d++)switch(c[d].once&&this.removeListener(r,c[d].fn,void 0,!0),l){case 1:c[d].fn.call(c[d].context);break;case 2:c[d].fn.call(c[d].context,e);break;case 3:c[d].fn.call(c[d].context,e,t);break;case 4:c[d].fn.call(c[d].context,e,t,n);break;default:if(!f)for(E=1,f=new Array(l-1);E<l;E++)f[E-1]=arguments[E];c[d].fn.apply(c[d].context,f)}}return!0};v.prototype.on=function(r,e,t){return ae(this,r,e,t,!1)};v.prototype.once=function(r,e,t){return ae(this,r,e,t,!0)};v.prototype.removeListener=function(r,e,t,n){var o=g?g+r:r;if(!this._events[o])return this;if(!e)return R(this,o),this;var a=this._events[o];if(a.fn)a.fn===e&&(!n||a.once)&&(!t||a.context===t)&&R(this,o);else{for(var s=0,c=[],l=a.length;s<l;s++)(a[s].fn!==e||n&&!a[s].once||t&&a[s].context!==t)&&c.push(a[s]);c.length?this._events[o]=c.length===1?c[0]:c:R(this,o)}return this};v.prototype.removeAllListeners=function(r){var e;return r?(e=g?g+r:r,this._events[e]&&R(this,e)):(this._events=new x,this._eventsCount=0),this};v.prototype.off=v.prototype.removeListener;v.prototype.addListener=v.prototype.on;v.prefixed=g;v.EventEmitter=v;D=v;var u={};w(u,"LogLevel",()=>m,i=>m=i);w(u,"default",()=>q,i=>q=i);var I=function(i,r){var e=typeof Symbol=="function"&&i[Symbol.iterator];if(!e)return i;var t=e.call(i),n,o=[],a;try{for(;(r===void 0||r-- >0)&&!(n=t.next()).done;)o.push(n.value)}catch(s){a={error:s}}finally{try{n&&!n.done&&(e=t.return)&&e.call(t)}finally{if(a)throw a.error}}return o},j=function(i,r,e){if(e||arguments.length===2)for(var t=0,n=r.length,o;t<n;t++)(o||!(t in r))&&(o||(o=Array.prototype.slice.call(r,0,t)),o[t]=r[t]);return i.concat(o||Array.prototype.slice.call(r))},he="PeerJS: ",m;(function(i){i[i.Disabled=0]="Disabled",i[i.Errors=1]="Errors",i[i.Warnings=2]="Warnings",i[i.All=3]="All"})(m||(m={}));var ye=function(){function i(){this._logLevel=m.Disabled}return Object.defineProperty(i.prototype,"logLevel",{get:function(){return this._logLevel},set:function(r){this._logLevel=r},enumerable:!1,configurable:!0}),i.prototype.log=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];this._logLevel>=m.All&&this._print.apply(this,j([m.All],I(r),!1))},i.prototype.warn=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];this._logLevel>=m.Warnings&&this._print.apply(this,j([m.Warnings],I(r),!1))},i.prototype.error=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];this._logLevel>=m.Errors&&this._print.apply(this,j([m.Errors],I(r),!1))},i.prototype.setLogFunction=function(r){this._print=r},i.prototype._print=function(r){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];var n=j([he],I(e),!1);for(var o in n)n[o]instanceof Error&&(n[o]="("+n[o].name+") "+n[o].message);r>=m.All||r>=m.Warnings||r>=m.Errors},i}(),q=new ye,se={};w(se,"Socket",()=>K,i=>K=i);var _;(function(i){i.Data="data",i.Media="media"})(_||(_={}));var h;(function(i){i.BrowserIncompatible="browser-incompatible",i.Disconnected="disconnected",i.InvalidID="invalid-id",i.InvalidKey="invalid-key",i.Network="network",i.PeerUnavailable="peer-unavailable",i.SslUnavailable="ssl-unavailable",i.ServerError="server-error",i.SocketError="socket-error",i.SocketClosed="socket-closed",i.UnavailableID="unavailable-id",i.WebRTC="webrtc"})(h||(h={}));var C;(function(i){i.Binary="binary",i.BinaryUTF8="binary-utf8",i.JSON="json"})(C||(C={}));var S;(function(i){i.Message="message",i.Disconnected="disconnected",i.Error="error",i.Close="close"})(S||(S={}));var y;(function(i){i.Heartbeat="HEARTBEAT",i.Candidate="CANDIDATE",i.Offer="OFFER",i.Answer="ANSWER",i.Open="OPEN",i.Error="ERROR",i.IdTaken="ID-TAKEN",i.InvalidKey="INVALID-KEY",i.Leave="LEAVE",i.Expire="EXPIRE"})(y||(y={}));var N={};N=JSON.parse('{"name":"peerjs","version":"1.4.7","keywords":["peerjs","webrtc","p2p","rtc"],"description":"PeerJS client","homepage":"https://peerjs.com","bugs":{"url":"https://github.com/peers/peerjs/issues"},"repository":{"type":"git","url":"https://github.com/peers/peerjs"},"license":"MIT","contributors":["Michelle Bu <michelle@michellebu.com>","afrokick <devbyru@gmail.com>","ericz <really.ez@gmail.com>","Jairo <kidandcat@gmail.com>","Jonas Gloning <34194370+jonasgloning@users.noreply.github.com>","Jairo Caro-Accino Viciana <jairo@galax.be>","Carlos Caballero <carlos.caballero.gonzalez@gmail.com>","hc <hheennrryy@gmail.com>","Muhammad Asif <capripio@gmail.com>","PrashoonB <prashoonbhattacharjee@gmail.com>","Harsh Bardhan Mishra <47351025+HarshCasper@users.noreply.github.com>","akotynski <aleksanderkotbury@gmail.com>","lmb <i@lmb.io>","Jairooo <jairocaro@msn.com>","Moritz St\xFCckler <moritz.stueckler@gmail.com>","Simon <crydotsnakegithub@gmail.com>","Denis Lukov <denismassters@gmail.com>","Philipp Hancke <fippo@andyet.net>","Hans Oksendahl <hansoksendahl@gmail.com>","Jess <jessachandler@gmail.com>","khankuan <khankuan@gmail.com>","DUODVK <kurmanov.work@gmail.com>","XiZhao <kwang1imsa@gmail.com>","Matthias Lohr <matthias@lohr.me>","=frank tree <=frnktrb@googlemail.com>","Andre Eckardt <aeckardt@outlook.com>","Chris Cowan <agentme49@gmail.com>","Alex Chuev <alex@chuev.com>","alxnull <alxnull@e.mail.de>","Yemel Jardi <angel.jardi@gmail.com>","Ben Parnell <benjaminparnell.94@gmail.com>","Benny Lichtner <bennlich@gmail.com>","fresheneesz <bitetrudpublic@gmail.com>","bob.barstead@exaptive.com <bob.barstead@exaptive.com>","chandika <chandika@gmail.com>","emersion <contact@emersion.fr>","Christopher Van <cvan@users.noreply.github.com>","eddieherm <edhermoso@gmail.com>","Eduardo Pinho <enet4mikeenet@gmail.com>","Evandro Zanatta <ezanatta@tray.net.br>","Gardner Bickford <gardner@users.noreply.github.com>","Gian Luca <gianluca.cecchi@cynny.com>","PatrickJS <github@gdi2290.com>","jonnyf <github@jonathanfoss.co.uk>","Hizkia Felix <hizkifw@gmail.com>","Hristo Oskov <hristo.oskov@gmail.com>","Isaac Madwed <i.madwed@gmail.com>","Ilya Konanykhin <ilya.konanykhin@gmail.com>","jasonbarry <jasbarry@me.com>","Jonathan Burke <jonathan.burke.1311@googlemail.com>","Josh Hamit <josh.hamit@gmail.com>","Jordan Austin <jrax86@gmail.com>","Joel Wetzell <jwetzell@yahoo.com>","xizhao <kevin.wang@cloudera.com>","Alberto Torres <kungfoobar@gmail.com>","Jonathan Mayol <mayoljonathan@gmail.com>","Jefferson Felix <me@jsfelix.dev>","Rolf Erik Lekang <me@rolflekang.com>","Kevin Mai-Husan Chia <mhchia@users.noreply.github.com>","Pepijn de Vos <pepijndevos@gmail.com>","JooYoung <qkdlql@naver.com>","Tobias Speicher <rootcommander@gmail.com>","Steve Blaurock <sblaurock@gmail.com>","Kyrylo Shegeda <shegeda@ualberta.ca>","Diwank Singh Tomer <singh@diwank.name>","So\u0308ren Balko <Soeren.Balko@gmail.com>","Arpit Solanki <solankiarpit1997@gmail.com>","Yuki Ito <yuki@gnnk.net>","Artur Zayats <zag2art@gmail.com>"],"funding":{"type":"opencollective","url":"https://opencollective.com/peer"},"collective":{"type":"opencollective","url":"https://opencollective.com/peer"},"files":["dist/*"],"sideEffects":["lib/global.ts","lib/supports.ts"],"main":"dist/bundler.cjs","module":"dist/bundler.mjs","browser-minified":"dist/peerjs.min.js","browser-unminified":"dist/peerjs.js","types":"dist/types.d.ts","engines":{"node":">= 10"},"targets":{"types":{"source":"lib/exports.ts"},"main":{"source":"lib/exports.ts","sourceMap":{"inlineSources":true}},"module":{"source":"lib/exports.ts","includeNodeModules":["eventemitter3"],"sourceMap":{"inlineSources":true}},"browser-minified":{"context":"browser","outputFormat":"global","optimize":true,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"},"browser-unminified":{"context":"browser","outputFormat":"global","optimize":false,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"}},"scripts":{"contributors":"git-authors-cli --print=false && prettier --write package.json && git add package.json package-lock.json && git commit -m \\"chore(contributors): update and sort contributors list\\"","check":"tsc --noEmit","watch":"parcel watch","build":"rm -rf dist && parcel build","prepublishOnly":"npm run build","test":"mocha -r ts-node/register -r jsdom-global/register test/**/*.ts","format":"prettier --write .","semantic-release":"semantic-release"},"devDependencies":{"@parcel/config-default":"^2.5.0","@parcel/packager-ts":"^2.5.0","@parcel/transformer-typescript-tsc":"^2.5.0","@parcel/transformer-typescript-types":"^2.5.0","@semantic-release/changelog":"^6.0.1","@semantic-release/git":"^10.0.1","@types/chai":"^4.3.0","@types/mocha":"^9.1.0","@types/node":"^17.0.18","chai":"^4.3.6","git-authors-cli":"^1.0.40","jsdom":"^19.0.0","jsdom-global":"^3.0.2","mocha":"^9.2.0","mock-socket":"8.0.5","parcel":"^2.5.0","parcel-transformer-tsc-sourcemaps":"^1.0.2","prettier":"^2.6.2","semantic-release":"^19.0.2","standard":"^16.0.4","ts-node":"^10.5.0","typescript":"^4.5.5"},"dependencies":{"@swc/helpers":"^0.3.13","eventemitter3":"^4.0.7","peerjs-js-binarypack":"1.0.1","webrtc-adapter":"^7.7.1"}}');var ve=function(){var i=function(r,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])},i(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),ge=function(i,r){var e=typeof Symbol=="function"&&i[Symbol.iterator];if(!e)return i;var t=e.call(i),n,o=[],a;try{for(;(r===void 0||r-- >0)&&!(n=t.next()).done;)o.push(n.value)}catch(s){a={error:s}}finally{try{n&&!n.done&&(e=t.return)&&e.call(t)}finally{if(a)throw a.error}}return o},me=function(i,r,e){if(e||arguments.length===2)for(var t=0,n=r.length,o;t<n;t++)(o||!(t in r))&&(o||(o=Array.prototype.slice.call(r,0,t)),o[t]=r[t]);return i.concat(o||Array.prototype.slice.call(r))},be=function(i){var r=typeof Symbol=="function"&&Symbol.iterator,e=r&&i[r],t=0;if(e)return e.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&t>=i.length&&(i=void 0),{value:i&&i[t++],done:!i}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},K=function(i){ve(r,i);function r(e,t,n,o,a,s){s===void 0&&(s=5e3);var c=i.call(this)||this;c.pingInterval=s,c._disconnected=!0,c._messagesQueue=[];var l=e?"wss://":"ws://";return c._baseUrl=l+t+":"+n+o+"peerjs?key="+a,c}return r.prototype.start=function(e,t){var n=this;this._id=e;var o="".concat(this._baseUrl,"&id=").concat(e,"&token=").concat(t);!!this._socket||!this._disconnected||(this._socket=new WebSocket(o+"&version="+N.version),this._disconnected=!1,this._socket.onmessage=function(a){var s;try{s=JSON.parse(a.data),u.default.log("Server message received:",s)}catch{u.default.log("Invalid server message",a.data);return}n.emit(S.Message,s)},this._socket.onclose=function(a){n._disconnected||(u.default.log("Socket closed.",a),n._cleanup(),n._disconnected=!0,n.emit(S.Disconnected))},this._socket.onopen=function(){n._disconnected||(n._sendQueuedMessages(),u.default.log("Socket open"),n._scheduleHeartbeat())})},r.prototype._scheduleHeartbeat=function(){var e=this;this._wsPingTimer=setTimeout(function(){e._sendHeartbeat()},this.pingInterval)},r.prototype._sendHeartbeat=function(){if(!this._wsOpen()){u.default.log("Cannot send heartbeat, because socket closed");return}var e=JSON.stringify({type:y.Heartbeat});this._socket.send(e),this._scheduleHeartbeat()},r.prototype._wsOpen=function(){return!!this._socket&&this._socket.readyState===1},r.prototype._sendQueuedMessages=function(){var e,t,n=me([],ge(this._messagesQueue),!1);this._messagesQueue=[];try{for(var o=be(n),a=o.next();!a.done;a=o.next()){var s=a.value;this.send(s)}}catch(c){e={error:c}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}},r.prototype.send=function(e){if(!this._disconnected){if(!this._id){this._messagesQueue.push(e);return}if(!e.type){this.emit(S.Error,"Invalid message");return}if(!!this._wsOpen()){var t=JSON.stringify(e);this._socket.send(t)}}},r.prototype.close=function(){this._disconnected||(this._cleanup(),this._disconnected=!0)},r.prototype._cleanup=function(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)},r}(D.EventEmitter),F={};w(F,"MediaConnection",()=>G,i=>G=i);var J={};w(J,"Negotiator",()=>Q,i=>Q=i);var L=function(){return L=Object.assign||function(i){for(var r,e=1,t=arguments.length;e<t;e++){r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(i[n]=r[n])}return i},L.apply(this,arguments)},A=function(i,r,e,t){function n(o){return o instanceof e?o:new e(function(a){a(o)})}return new(e||(e=Promise))(function(o,a){function s(f){try{l(t.next(f))}catch(d){a(d)}}function c(f){try{l(t.throw(f))}catch(d){a(d)}}function l(f){f.done?o(f.value):n(f.value).then(s,c)}l((t=t.apply(i,r||[])).next())})},M=function(i,r){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},t,n,o,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(l){return function(f){return c([l,f])}}function c(l){if(t)throw new TypeError("Generator is already executing.");for(;e;)try{if(t=1,n&&(o=l[0]&2?n.return:l[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,l[1])).done)return o;switch(n=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return e.label++,{value:l[1],done:!1};case 5:e.label++,n=l[1],l=[0];continue;case 7:l=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){e=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){e.label=l[1];break}if(l[0]===6&&e.label<o[1]){e.label=o[1],o=l;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(l);break}o[2]&&e.ops.pop(),e.trys.pop();continue}l=r.call(i,e)}catch(f){l=[6,f],n=0}finally{t=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}},Q=function(){function i(r){this.connection=r}return i.prototype.startConnection=function(r){var e=this._startPeerConnection();if(this.connection.peerConnection=e,this.connection.type===_.Media&&r._stream&&this._addTracksToConnection(r._stream,e),r.originator){if(this.connection.type===_.Data){var t=this.connection,n={ordered:!!r.reliable},o=e.createDataChannel(t.label,n);t.initialize(o)}this._makeOffer()}else this.handleSDP("OFFER",r.sdp)},i.prototype._startPeerConnection=function(){u.default.log("Creating RTCPeerConnection.");var r=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(r),r},i.prototype._setupListeners=function(r){var e=this,t=this.connection.peer,n=this.connection.connectionId,o=this.connection.type,a=this.connection.provider;u.default.log("Listening for ICE candidates."),r.onicecandidate=function(s){!s.candidate||!s.candidate.candidate||(u.default.log("Received ICE candidates for ".concat(t,":"),s.candidate),a.socket.send({type:y.Candidate,payload:{candidate:s.candidate,type:o,connectionId:n},dst:t}))},r.oniceconnectionstatechange=function(){switch(r.iceConnectionState){case"failed":u.default.log("iceConnectionState is failed, closing connections to "+t),e.connection.emit("error",new Error("Negotiation of connection to "+t+" failed.")),e.connection.close();break;case"closed":u.default.log("iceConnectionState is closed, closing connections to "+t),e.connection.emit("error",new Error("Connection to "+t+" closed.")),e.connection.close();break;case"disconnected":u.default.log("iceConnectionState changed to disconnected on the connection with "+t);break;case"completed":r.onicecandidate=p.noop;break}e.connection.emit("iceStateChanged",r.iceConnectionState)},u.default.log("Listening for data channel"),r.ondatachannel=function(s){u.default.log("Received data channel");var c=s.channel,l=a.getConnection(t,n);l.initialize(c)},u.default.log("Listening for remote stream"),r.ontrack=function(s){u.default.log("Received remote stream");var c=s.streams[0],l=a.getConnection(t,n);if(l.type===_.Media){var f=l;e._addStreamToMediaConnection(c,f)}}},i.prototype.cleanup=function(){u.default.log("Cleaning up PeerConnection to "+this.connection.peer);var r=this.connection.peerConnection;if(!!r){this.connection.peerConnection=null,r.onicecandidate=r.oniceconnectionstatechange=r.ondatachannel=r.ontrack=function(){};var e=r.signalingState!=="closed",t=!1;if(this.connection.type===_.Data){var n=this.connection,o=n.dataChannel;o&&(t=!!o.readyState&&o.readyState!=="closed")}(e||t)&&r.close()}},i.prototype._makeOffer=function(){return A(this,void 0,Promise,function(){var r,e,t,n,o,a,s;return M(this,function(c){switch(c.label){case 0:r=this.connection.peerConnection,e=this.connection.provider,c.label=1;case 1:return c.trys.push([1,7,,8]),[4,r.createOffer(this.connection.options.constraints)];case 2:t=c.sent(),u.default.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(t.sdp=this.connection.options.sdpTransform(t.sdp)||t.sdp),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,r.setLocalDescription(t)];case 4:return c.sent(),u.default.log("Set localDescription:",t,"for:".concat(this.connection.peer)),n={sdp:t,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata,browser:p.browser},this.connection.type===_.Data&&(o=this.connection,n=L(L({},n),{label:o.label,reliable:o.reliable,serialization:o.serialization})),e.socket.send({type:y.Offer,payload:n,dst:this.connection.peer}),[3,6];case 5:return a=c.sent(),a!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(e.emitError(h.WebRTC,a),u.default.log("Failed to setLocalDescription, ",a)),[3,6];case 6:return[3,8];case 7:return s=c.sent(),e.emitError(h.WebRTC,s),u.default.log("Failed to createOffer, ",s),[3,8];case 8:return[2]}})})},i.prototype._makeAnswer=function(){return A(this,void 0,Promise,function(){var r,e,t,n,o;return M(this,function(a){switch(a.label){case 0:r=this.connection.peerConnection,e=this.connection.provider,a.label=1;case 1:return a.trys.push([1,7,,8]),[4,r.createAnswer()];case 2:t=a.sent(),u.default.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(t.sdp=this.connection.options.sdpTransform(t.sdp)||t.sdp),a.label=3;case 3:return a.trys.push([3,5,,6]),[4,r.setLocalDescription(t)];case 4:return a.sent(),u.default.log("Set localDescription:",t,"for:".concat(this.connection.peer)),e.socket.send({type:y.Answer,payload:{sdp:t,type:this.connection.type,connectionId:this.connection.connectionId,browser:p.browser},dst:this.connection.peer}),[3,6];case 5:return n=a.sent(),e.emitError(h.WebRTC,n),u.default.log("Failed to setLocalDescription, ",n),[3,6];case 6:return[3,8];case 7:return o=a.sent(),e.emitError(h.WebRTC,o),u.default.log("Failed to create answer, ",o),[3,8];case 8:return[2]}})})},i.prototype.handleSDP=function(r,e){return A(this,void 0,Promise,function(){var t,n,o,a;return M(this,function(s){switch(s.label){case 0:e=new RTCSessionDescription(e),t=this.connection.peerConnection,n=this.connection.provider,u.default.log("Setting remote description",e),o=this,s.label=1;case 1:return s.trys.push([1,5,,6]),[4,t.setRemoteDescription(e)];case 2:return s.sent(),u.default.log("Set remoteDescription:".concat(r," for:").concat(this.connection.peer)),r!=="OFFER"?[3,4]:[4,o._makeAnswer()];case 3:s.sent(),s.label=4;case 4:return[3,6];case 5:return a=s.sent(),n.emitError(h.WebRTC,a),u.default.log("Failed to setRemoteDescription, ",a),[3,6];case 6:return[2]}})})},i.prototype.handleCandidate=function(r){return A(this,void 0,Promise,function(){var e,t,n,o,a,s;return M(this,function(c){switch(c.label){case 0:u.default.log("handleCandidate:",r),e=r.candidate,t=r.sdpMLineIndex,n=r.sdpMid,o=this.connection.peerConnection,a=this.connection.provider,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,o.addIceCandidate(new RTCIceCandidate({sdpMid:n,sdpMLineIndex:t,candidate:e}))];case 2:return c.sent(),u.default.log("Added ICE candidate for:".concat(this.connection.peer)),[3,4];case 3:return s=c.sent(),a.emitError(h.WebRTC,s),u.default.log("Failed to handleCandidate, ",s),[3,4];case 4:return[2]}})})},i.prototype._addTracksToConnection=function(r,e){if(u.default.log("add tracks from stream ".concat(r.id," to peer connection")),!e.addTrack)return u.default.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");r.getTracks().forEach(function(t){e.addTrack(t,r)})},i.prototype._addStreamToMediaConnection=function(r,e){u.default.log("add stream ".concat(r.id," to media connection ").concat(e.connectionId)),e.addStream(r)},i}(),H={};w(H,"BaseConnection",()=>X,i=>X=i);var _e=function(){var i=function(r,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])},i(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),X=function(i){_e(r,i);function r(e,t,n){var o=i.call(this)||this;return o.peer=e,o.provider=t,o.options=n,o._open=!1,o.metadata=n.metadata,o}return Object.defineProperty(r.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),r}(D.EventEmitter),we=function(){var i=function(r,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])},i(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),B=function(){return B=Object.assign||function(i){for(var r,e=1,t=arguments.length;e<t;e++){r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(i[n]=r[n])}return i},B.apply(this,arguments)},ke=function(i){var r=typeof Symbol=="function"&&Symbol.iterator,e=r&&i[r],t=0;if(e)return e.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&t>=i.length&&(i=void 0),{value:i&&i[t++],done:!i}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},G=function(i){we(r,i);function r(e,t,n){var o=i.call(this,e,t,n)||this;return o._localStream=o.options._stream,o.connectionId=o.options.connectionId||r.ID_PREFIX+p.randomToken(),o._negotiator=new J.Negotiator(o),o._localStream&&o._negotiator.startConnection({_stream:o._localStream,originator:!0}),o}return Object.defineProperty(r.prototype,"type",{get:function(){return _.Media},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"localStream",{get:function(){return this._localStream},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"remoteStream",{get:function(){return this._remoteStream},enumerable:!1,configurable:!0}),r.prototype.addStream=function(e){u.default.log("Receiving stream",e),this._remoteStream=e,i.prototype.emit.call(this,"stream",e)},r.prototype.handleMessage=function(e){var t=e.type,n=e.payload;switch(e.type){case y.Answer:this._negotiator.handleSDP(t,n.sdp),this._open=!0;break;case y.Candidate:this._negotiator.handleCandidate(n.candidate);break;default:u.default.warn("Unrecognized message type:".concat(t," from peer:").concat(this.peer));break}},r.prototype.answer=function(e,t){var n,o;if(t===void 0&&(t={}),this._localStream){u.default.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=e,t&&t.sdpTransform&&(this.options.sdpTransform=t.sdpTransform),this._negotiator.startConnection(B(B({},this.options._payload),{_stream:e}));var a=this.provider._getMessages(this.connectionId);try{for(var s=ke(a),c=s.next();!c.done;c=s.next()){var l=c.value;this.handleMessage(l)}}catch(f){n={error:f}}finally{try{c&&!c.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}this._open=!0},r.prototype.close=function(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,i.prototype.emit.call(this,"close"))},r.ID_PREFIX="mc_",r}(H.BaseConnection),U={};w(U,"DataConnection",()=>ee,i=>ee=i);var ce={};w(ce,"EncodingQueue",()=>Z,i=>Z=i);var Ce=function(){var i=function(r,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])},i(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),Z=function(i){Ce(r,i);function r(){var e=i.call(this)||this;return e.fileReader=new FileReader,e._queue=[],e._processing=!1,e.fileReader.onload=function(t){e._processing=!1,t.target&&e.emit("done",t.target.result),e.doNextTask()},e.fileReader.onerror=function(t){u.default.error("EncodingQueue error:",t),e._processing=!1,e.destroy(),e.emit("error",t)},e}return Object.defineProperty(r.prototype,"queue",{get:function(){return this._queue},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"size",{get:function(){return this.queue.length},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"processing",{get:function(){return this._processing},enumerable:!1,configurable:!0}),r.prototype.enque=function(e){this.queue.push(e),!this.processing&&this.doNextTask()},r.prototype.destroy=function(){this.fileReader.abort(),this._queue=[]},r.prototype.doNextTask=function(){this.size!==0&&(this.processing||(this._processing=!0,this.fileReader.readAsArrayBuffer(this.queue.shift())))},r}(D.EventEmitter),Se=function(){var i=function(r,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])},i(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),Oe=function(i){var r=typeof Symbol=="function"&&Symbol.iterator,e=r&&i[r],t=0;if(e)return e.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&t>=i.length&&(i=void 0),{value:i&&i[t++],done:!i}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},ee=function(i){Se(r,i);function r(e,t,n){var o=i.call(this,e,t,n)||this;return o.stringify=JSON.stringify,o.parse=JSON.parse,o._buffer=[],o._bufferSize=0,o._buffering=!1,o._chunkedData={},o._encodingQueue=new ce.EncodingQueue,o.connectionId=o.options.connectionId||r.ID_PREFIX+p.randomToken(),o.label=o.options.label||o.connectionId,o.serialization=o.options.serialization||C.Binary,o.reliable=!!o.options.reliable,o._encodingQueue.on("done",function(a){o._bufferedSend(a)}),o._encodingQueue.on("error",function(){u.default.error("DC#".concat(o.connectionId,": Error occured in encoding from blob to arraybuffer, close DC")),o.close()}),o._negotiator=new J.Negotiator(o),o._negotiator.startConnection(o.options._payload||{originator:!0}),o}return Object.defineProperty(r.prototype,"type",{get:function(){return _.Data},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"dataChannel",{get:function(){return this._dc},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"bufferSize",{get:function(){return this._bufferSize},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){this._dc=e,this._configureDataChannel()},r.prototype._configureDataChannel=function(){var e=this;(!p.supports.binaryBlob||p.supports.reliable)&&(this.dataChannel.binaryType="arraybuffer"),this.dataChannel.onopen=function(){u.default.log("DC#".concat(e.connectionId," dc connection success")),e._open=!0,e.emit("open")},this.dataChannel.onmessage=function(t){u.default.log("DC#".concat(e.connectionId," dc onmessage:"),t.data),e._handleDataMessage(t)},this.dataChannel.onclose=function(){u.default.log("DC#".concat(e.connectionId," dc closed for:"),e.peer),e.close()}},r.prototype._handleDataMessage=function(e){var t=this,n=e.data,o=n.constructor,a=this.serialization===C.Binary||this.serialization===C.BinaryUTF8,s=n;if(a){if(o===Blob){p.blobToArrayBuffer(n,function(l){var f=p.unpack(l);t.emit("data",f)});return}else if(o===ArrayBuffer)s=p.unpack(n);else if(o===String){var c=p.binaryStringToArrayBuffer(n);s=p.unpack(c)}}else this.serialization===C.JSON&&(s=this.parse(n));if(s.__peerData){this._handleChunk(s);return}i.prototype.emit.call(this,"data",s)},r.prototype._handleChunk=function(e){var t=e.__peerData,n=this._chunkedData[t]||{data:[],count:0,total:e.total};if(n.data[e.n]=e.data,n.count++,this._chunkedData[t]=n,n.total===n.count){delete this._chunkedData[t];var o=new Blob(n.data);this._handleDataMessage({data:o})}},r.prototype.close=function(){this._buffer=[],this._bufferSize=0,this._chunkedData={},this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this._dc=null),this._encodingQueue&&(this._encodingQueue.destroy(),this._encodingQueue.removeAllListeners(),this._encodingQueue=null),this.open&&(this._open=!1,i.prototype.emit.call(this,"close"))},r.prototype.send=function(e,t){if(!this.open){i.prototype.emit.call(this,"error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));return}if(this.serialization===C.JSON)this._bufferedSend(this.stringify(e));else if(this.serialization===C.Binary||this.serialization===C.BinaryUTF8){var n=p.pack(e);if(!t&&n.size>p.chunkedMTU){this._sendChunks(n);return}p.supports.binaryBlob?this._bufferedSend(n):this._encodingQueue.enque(n)}else this._bufferedSend(e)},r.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this._bufferSize=this._buffer.length)},r.prototype._trySend=function(e){var t=this;if(!this.open)return!1;if(this.dataChannel.bufferedAmount>r.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(function(){t._buffering=!1,t._tryBuffer()},50),!1;try{this.dataChannel.send(e)}catch(n){return u.default.error("DC#:".concat(this.connectionId," Error when sending:"),n),this._buffering=!0,this.close(),!1}return!0},r.prototype._tryBuffer=function(){if(!!this.open&&this._buffer.length!==0){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}},r.prototype._sendChunks=function(e){var t,n,o=p.chunk(e);u.default.log("DC#".concat(this.connectionId," Try to send ").concat(o.length," chunks..."));try{for(var a=Oe(o),s=a.next();!s.done;s=a.next()){var c=s.value;this.send(c,!0)}}catch(l){t={error:l}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}},r.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case y.Answer:this._negotiator.handleSDP(e.type,t.sdp);break;case y.Candidate:this._negotiator.handleCandidate(t.candidate);break;default:u.default.warn("Unrecognized message type:",e.type,"from peer:",this.peer);break}},r.ID_PREFIX="dc_",r.MAX_BUFFERED_AMOUNT=8388608,r}(H.BaseConnection),le={};w(le,"API",()=>ne,i=>ne=i);var te=function(i,r,e,t){function n(o){return o instanceof e?o:new e(function(a){a(o)})}return new(e||(e=Promise))(function(o,a){function s(f){try{l(t.next(f))}catch(d){a(d)}}function c(f){try{l(t.throw(f))}catch(d){a(d)}}function l(f){f.done?o(f.value):n(f.value).then(s,c)}l((t=t.apply(i,r||[])).next())})},re=function(i,r){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},t,n,o,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(l){return function(f){return c([l,f])}}function c(l){if(t)throw new TypeError("Generator is already executing.");for(;e;)try{if(t=1,n&&(o=l[0]&2?n.return:l[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,l[1])).done)return o;switch(n=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return e.label++,{value:l[1],done:!1};case 5:e.label++,n=l[1],l=[0];continue;case 7:l=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){e=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){e.label=l[1];break}if(l[0]===6&&e.label<o[1]){e.label=o[1],o=l;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(l);break}o[2]&&e.ops.pop(),e.trys.pop();continue}l=r.call(i,e)}catch(f){l=[6,f],n=0}finally{t=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}},ne=function(){function i(r){this._options=r}return i.prototype._buildRequest=function(r){var e=this._options.secure?"https":"http",t=this._options,n=t.host,o=t.port,a=t.path,s=t.key,c=new URL("".concat(e,"://").concat(n,":").concat(o).concat(a).concat(s,"/").concat(r));return c.searchParams.set("ts","".concat(Date.now()).concat(Math.random())),c.searchParams.set("version",N.version),fetch(c.href,{referrerPolicy:this._options.referrerPolicy})},i.prototype.retrieveId=function(){return te(this,void 0,Promise,function(){var r,e,t;return re(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("id")];case 1:if(r=n.sent(),r.status!==200)throw new Error("Error. Status:".concat(r.status));return[2,r.text()];case 2:throw e=n.sent(),u.default.error("Error retrieving ID",e),t="",this._options.path==="/"&&this._options.host!==p.CLOUD_HOST&&(t=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+t);case 3:return[2]}})})},i.prototype.listAllPeers=function(){return te(this,void 0,Promise,function(){var r,e,t;return re(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("peers")];case 1:if(r=n.sent(),r.status!==200)throw r.status===401?(e="",this._options.host===p.CLOUD_HOST?e="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":e="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+e)):new Error("Error. Status:".concat(r.status));return[2,r.json()];case 2:throw t=n.sent(),u.default.error("Error retrieving list peers",t),new Error("Could not get list peers from the server."+t);case 3:return[2]}})})},i}(),Ee=function(){var i=function(r,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])},i(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),P=function(){return P=Object.assign||function(i){for(var r,e=1,t=arguments.length;e<t;e++){r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(i[n]=r[n])}return i},P.apply(this,arguments)},T=function(i){var r=typeof Symbol=="function"&&Symbol.iterator,e=r&&i[r],t=0;if(e)return e.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&t>=i.length&&(i=void 0),{value:i&&i[t++],done:!i}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},$e=function(i,r){var e=typeof Symbol=="function"&&i[Symbol.iterator];if(!e)return i;var t=e.call(i),n,o=[],a;try{for(;(r===void 0||r-- >0)&&!(n=t.next()).done;)o.push(n.value)}catch(s){a={error:s}}finally{try{n&&!n.done&&(e=t.return)&&e.call(t)}finally{if(a)throw a.error}}return o},oe=function(i){Ee(r,i);function r(e,t){var n=i.call(this)||this;n._id=null,n._lastServerId=null,n._destroyed=!1,n._disconnected=!1,n._open=!1,n._connections=new Map,n._lostMessages=new Map;var o;return e&&e.constructor==Object?t=e:e&&(o=e.toString()),t=P({debug:0,host:p.CLOUD_HOST,port:p.CLOUD_PORT,path:"/",key:r.DEFAULT_KEY,token:p.randomToken(),config:p.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin"},t),n._options=t,n._options.host==="/"&&(n._options.host=window.location.hostname),n._options.path&&(n._options.path[0]!=="/"&&(n._options.path="/"+n._options.path),n._options.path[n._options.path.length-1]!=="/"&&(n._options.path+="/")),n._options.secure===void 0&&n._options.host!==p.CLOUD_HOST?n._options.secure=p.isSecure():n._options.host==p.CLOUD_HOST&&(n._options.secure=!0),n._options.logFunction&&u.default.setLogFunction(n._options.logFunction),u.default.logLevel=n._options.debug||0,n._api=new le.API(t),n._socket=n._createServerConnection(),!p.supports.audioVideo&&!p.supports.data?(n._delayedAbort(h.BrowserIncompatible,"The current browser does not support WebRTC"),n):!!o&&!p.validateId(o)?(n._delayedAbort(h.InvalidID,'ID "'.concat(o,'" is invalid')),n):(o?n._initialize(o):n._api.retrieveId().then(function(a){return n._initialize(a)}).catch(function(a){return n._abort(h.ServerError,a)}),n)}return Object.defineProperty(r.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"socket",{get:function(){return this._socket},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"connections",{get:function(){var e,t,n=Object.create(null);try{for(var o=T(this._connections),a=o.next();!a.done;a=o.next()){var s=$e(a.value,2),c=s[0],l=s[1];n[c]=l}}catch(f){e={error:f}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"disconnected",{get:function(){return this._disconnected},enumerable:!1,configurable:!0}),r.prototype._createServerConnection=function(){var e=this,t=new se.Socket(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return t.on(S.Message,function(n){e._handleMessage(n)}),t.on(S.Error,function(n){e._abort(h.SocketError,n)}),t.on(S.Disconnected,function(){e.disconnected||(e.emitError(h.Network,"Lost connection to server."),e.disconnect())}),t.on(S.Close,function(){e.disconnected||e._abort(h.SocketClosed,"Underlying socket is already closed.")}),t},r.prototype._initialize=function(e){this._id=e,this.socket.start(e,this._options.token)},r.prototype._handleMessage=function(e){var t,n,o=e.type,a=e.payload,s=e.src;switch(o){case y.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case y.Error:this._abort(h.ServerError,a.msg);break;case y.IdTaken:this._abort(h.UnavailableID,'ID "'.concat(this.id,'" is taken'));break;case y.InvalidKey:this._abort(h.InvalidKey,'API KEY "'.concat(this._options.key,'" is invalid'));break;case y.Leave:u.default.log("Received leave message from ".concat(s)),this._cleanupPeer(s),this._connections.delete(s);break;case y.Expire:this.emitError(h.PeerUnavailable,"Could not connect to peer ".concat(s));break;case y.Offer:var k=a.connectionId,b=this.getConnection(s,k);if(b&&(b.close(),u.default.warn("Offer received for existing Connection ID:".concat(k))),a.type===_.Media){var c=new F.MediaConnection(s,this,{connectionId:k,_payload:a,metadata:a.metadata});b=c,this._addConnection(s,b),this.emit("call",c)}else if(a.type===_.Data){var l=new U.DataConnection(s,this,{connectionId:k,_payload:a,metadata:a.metadata,label:a.label,serialization:a.serialization,reliable:a.reliable});b=l,this._addConnection(s,b),this.emit("connection",l)}else{u.default.warn("Received malformed connection type:".concat(a.type));return}var f=this._getMessages(k);try{for(var d=T(f),O=d.next();!O.done;O=d.next()){var E=O.value;b.handleMessage(E)}}catch(ue){t={error:ue}}finally{try{O&&!O.done&&(n=d.return)&&n.call(d)}finally{if(t)throw t.error}}break;default:if(!a){u.default.warn("You received a malformed message from ".concat(s," of type ").concat(o));return}var k=a.connectionId,b=this.getConnection(s,k);b&&b.peerConnection?b.handleMessage(e):k?this._storeMessage(k,e):u.default.warn("You received an unrecognized message:",e);break}},r.prototype._storeMessage=function(e,t){this._lostMessages.has(e)||this._lostMessages.set(e,[]),this._lostMessages.get(e).push(t)},r.prototype._getMessages=function(e){var t=this._lostMessages.get(e);return t?(this._lostMessages.delete(e),t):[]},r.prototype.connect=function(e,t){if(t===void 0&&(t={}),this.disconnected){u.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError(h.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}var n=new U.DataConnection(e,this,t);return this._addConnection(e,n),n},r.prototype.call=function(e,t,n){if(n===void 0&&(n={}),this.disconnected){u.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError(h.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}if(!t){u.default.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}var o=new F.MediaConnection(e,this,P(P({},n),{_stream:t}));return this._addConnection(e,o),o},r.prototype._addConnection=function(e,t){u.default.log("add connection ".concat(t.type,":").concat(t.connectionId," to peerId:").concat(e)),this._connections.has(e)||this._connections.set(e,[]),this._connections.get(e).push(t)},r.prototype._removeConnection=function(e){var t=this._connections.get(e.peer);if(t){var n=t.indexOf(e);n!==-1&&t.splice(n,1)}this._lostMessages.delete(e.connectionId)},r.prototype.getConnection=function(e,t){var n,o,a=this._connections.get(e);if(!a)return null;try{for(var s=T(a),c=s.next();!c.done;c=s.next()){var l=c.value;if(l.connectionId===t)return l}}catch(f){n={error:f}}finally{try{c&&!c.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}return null},r.prototype._delayedAbort=function(e,t){var n=this;setTimeout(function(){n._abort(e,t)},0)},r.prototype._abort=function(e,t){u.default.error("Aborting!"),this.emitError(e,t),this._lastServerId?this.disconnect():this.destroy()},r.prototype.emitError=function(e,t){u.default.error("Error:",t);var n;typeof t=="string"?n=new Error(t):n=t,n.type=e,this.emit("error",n)},r.prototype.destroy=function(){this.destroyed||(u.default.log("Destroy peer with ID:".concat(this.id)),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close"))},r.prototype._cleanup=function(){var e,t;try{for(var n=T(this._connections.keys()),o=n.next();!o.done;o=n.next()){var a=o.value;this._cleanupPeer(a),this._connections.delete(a)}}catch(s){e={error:s}}finally{try{o&&!o.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}this.socket.removeAllListeners()},r.prototype._cleanupPeer=function(e){var t,n,o=this._connections.get(e);if(!!o)try{for(var a=T(o),s=a.next();!s.done;s=a.next()){var c=s.value;c.close()}}catch(l){t={error:l}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}},r.prototype.disconnect=function(){if(!this.disconnected){var e=this.id;u.default.log("Disconnect peer with ID:".concat(e)),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=e,this._id=null,this.emit("disconnected",e)}},r.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)u.default.log("Attempting reconnection to server with ID ".concat(this._lastServerId)),this._disconnected=!1,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)u.default.error("In a hurry? We're still trying to make the initial connection!");else throw new Error("Peer ".concat(this.id," cannot reconnect because it is not disconnected from the server!"))}},r.prototype.listAllPeers=function(e){var t=this;e===void 0&&(e=function(n){}),this._api.listAllPeers().then(function(n){return e(n)}).catch(function(n){return t._abort(h.ServerError,n)})},r.DEFAULT_KEY="peerjs",r}(D.EventEmitter),xe=ie.Peer;export{xe as $};
