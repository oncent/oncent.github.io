import{s as ee}from"./sdp.c10b5003.js";var c=ee.exports;function te(o){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[o.type]||o.type}function Y(o,m,T,g,R){var i=c.writeRtpDescription(o.kind,m);if(i+=c.writeIceParameters(o.iceGatherer.getLocalParameters()),i+=c.writeDtlsParameters(o.dtlsTransport.getLocalParameters(),T==="offer"?"actpass":R||"active"),i+="a=mid:"+o.mid+`\r
`,o.rtpSender&&o.rtpReceiver?i+=`a=sendrecv\r
`:o.rtpSender?i+=`a=sendonly\r
`:o.rtpReceiver?i+=`a=recvonly\r
`:i+=`a=inactive\r
`,o.rtpSender){var v=o.rtpSender._initialTrackId||o.rtpSender.track.id;o.rtpSender._initialTrackId=v;var h="msid:"+(g?g.id:"-")+" "+v+`\r
`;i+="a="+h,i+="a=ssrc:"+o.sendEncodingParameters[0].ssrc+" "+h,o.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+o.sendEncodingParameters[0].rtx.ssrc+" "+h,i+="a=ssrc-group:FID "+o.sendEncodingParameters[0].ssrc+" "+o.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return i+="a=ssrc:"+o.sendEncodingParameters[0].ssrc+" cname:"+c.localCName+`\r
`,o.rtpSender&&o.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+o.sendEncodingParameters[0].rtx.ssrc+" cname:"+c.localCName+`\r
`),i}function re(o,m){var T=!1;return o=JSON.parse(JSON.stringify(o)),o.filter(function(g){if(g&&(g.urls||g.url)){var R=g.urls||g.url;g.url&&g.urls;var i=typeof R=="string";return i&&(R=[R]),R=R.filter(function(v){var h=v.indexOf("turn:")===0&&v.indexOf("transport=udp")!==-1&&v.indexOf("turn:[")===-1&&!T;return h?(T=!0,!0):v.indexOf("stun:")===0&&m>=14393&&v.indexOf("?transport=udp")===-1}),delete g.url,g.urls=i?R[0]:R,!!R.length}})}function x(o,m){var T={codecs:[],headerExtensions:[],fecMechanisms:[]},g=function(i,v){i=parseInt(i,10);for(var h=0;h<v.length;h++)if(v[h].payloadType===i||v[h].preferredPayloadType===i)return v[h]},R=function(i,v,h,e){var t=g(i.parameters.apt,h),a=g(v.parameters.apt,e);return t&&a&&t.name.toLowerCase()===a.name.toLowerCase()};return o.codecs.forEach(function(i){for(var v=0;v<m.codecs.length;v++){var h=m.codecs[v];if(i.name.toLowerCase()===h.name.toLowerCase()&&i.clockRate===h.clockRate){if(i.name.toLowerCase()==="rtx"&&i.parameters&&h.parameters.apt&&!R(i,h,o.codecs,m.codecs))continue;h=JSON.parse(JSON.stringify(h)),h.numChannels=Math.min(i.numChannels,h.numChannels),T.codecs.push(h),h.rtcpFeedback=h.rtcpFeedback.filter(function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),o.headerExtensions.forEach(function(i){for(var v=0;v<m.headerExtensions.length;v++){var h=m.headerExtensions[v];if(i.uri===h.uri){T.headerExtensions.push(h);break}}}),T}function Z(o,m,T){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[m][o].indexOf(T)!==-1}function V(o,m){var T=o.getRemoteCandidates().find(function(g){return m.foundation===g.foundation&&m.ip===g.ip&&m.port===g.port&&m.priority===g.priority&&m.protocol===g.protocol&&m.type===g.type});return T||o.addRemoteCandidate(m),!T}function C(o,m){var T=new Error(m);return T.name=o,T.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[o],T}var ne=function(o,m){function T(e,t){t.addTrack(e),t.dispatchEvent(new o.MediaStreamTrackEvent("addtrack",{track:e}))}function g(e,t){t.removeTrack(e),t.dispatchEvent(new o.MediaStreamTrackEvent("removetrack",{track:e}))}function R(e,t,a,r){var n=new Event("track");n.track=t,n.receiver=a,n.transceiver={receiver:a},n.streams=r,o.setTimeout(function(){e._dispatchEvent("track",n)})}var i=function(e){var t=this,a=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(n){t[n]=a[n].bind(a)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",e=JSON.parse(JSON.stringify(e||{})),this.usingBundle=e.bundlePolicy==="max-bundle",e.rtcpMuxPolicy==="negotiate")throw C("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(e.rtcpMuxPolicy||(e.rtcpMuxPolicy="require"),e.iceTransportPolicy){case"all":case"relay":break;default:e.iceTransportPolicy="all";break}switch(e.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:e.bundlePolicy="balanced";break}if(e.iceServers=re(e.iceServers||[],m),this._iceGatherers=[],e.iceCandidatePoolSize)for(var r=e.iceCandidatePoolSize;r>0;r--)this._iceGatherers.push(new o.RTCIceGatherer({iceServers:e.iceServers,gatherPolicy:e.iceTransportPolicy}));else e.iceCandidatePoolSize=0;this._config=e,this.transceivers=[],this._sdpSessionId=c.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(i.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(i.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),i.prototype.onicecandidate=null,i.prototype.onaddstream=null,i.prototype.ontrack=null,i.prototype.onremovestream=null,i.prototype.onsignalingstatechange=null,i.prototype.oniceconnectionstatechange=null,i.prototype.onconnectionstatechange=null,i.prototype.onicegatheringstatechange=null,i.prototype.onnegotiationneeded=null,i.prototype.ondatachannel=null,i.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),typeof this["on"+e]=="function"&&this["on"+e](t))},i.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},i.prototype.getConfiguration=function(){return this._config},i.prototype.getLocalStreams=function(){return this.localStreams},i.prototype.getRemoteStreams=function(){return this.remoteStreams},i.prototype._createTransceiver=function(e,t){var a=this.transceivers.length>0,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&a)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();r.iceTransport=n.iceTransport,r.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(r),r},i.prototype.addTrack=function(e,t){if(this._isClosed)throw C("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var a=this.transceivers.find(function(l){return l.track===e});if(a)throw C("InvalidAccessError","Track already exists.");for(var r,n=0;n<this.transceivers.length;n++)!this.transceivers[n].track&&this.transceivers[n].kind===e.kind&&(r=this.transceivers[n]);return r||(r=this._createTransceiver(e.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(t)===-1&&this.localStreams.push(t),r.track=e,r.stream=t,r.rtpSender=new o.RTCRtpSender(e,r.dtlsTransport),r.rtpSender},i.prototype.addStream=function(e){var t=this;if(m>=15025)e.getTracks().forEach(function(r){t.addTrack(r,e)});else{var a=e.clone();e.getTracks().forEach(function(r,n){var l=a.getTracks()[n];r.addEventListener("enabled",function(s){l.enabled=s.enabled})}),a.getTracks().forEach(function(r){t.addTrack(r,a)})}},i.prototype.removeTrack=function(e){if(this._isClosed)throw C("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(e instanceof o.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var t=this.transceivers.find(function(n){return n.rtpSender===e});if(!t)throw C("InvalidAccessError","Sender was not created by this connection.");var a=t.stream;t.rtpSender.stop(),t.rtpSender=null,t.track=null,t.stream=null;var r=this.transceivers.map(function(n){return n.stream});r.indexOf(a)===-1&&this.localStreams.indexOf(a)>-1&&this.localStreams.splice(this.localStreams.indexOf(a),1),this._maybeFireNegotiationNeeded()},i.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(a){var r=t.getSenders().find(function(n){return n.track===a});r&&t.removeTrack(r)})},i.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},i.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},i.prototype._createIceGatherer=function(e,t){var a=this;if(t&&e>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var r=new o.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[e].bufferedCandidateEvents=[],this.transceivers[e].bufferCandidates=function(n){var l=!n.candidate||Object.keys(n.candidate).length===0;r.state=l?"completed":"gathering",a.transceivers[e].bufferedCandidateEvents!==null&&a.transceivers[e].bufferedCandidateEvents.push(n)},r.addEventListener("localcandidate",this.transceivers[e].bufferCandidates),r},i.prototype._gather=function(e,t){var a=this,r=this.transceivers[t].iceGatherer;if(!r.onlocalcandidate){var n=this.transceivers[t].bufferedCandidateEvents;this.transceivers[t].bufferedCandidateEvents=null,r.removeEventListener("localcandidate",this.transceivers[t].bufferCandidates),r.onlocalcandidate=function(l){if(!(a.usingBundle&&t>0)){var s=new Event("icecandidate");s.candidate={sdpMid:e,sdpMLineIndex:t};var u=l.candidate,E=!u||Object.keys(u).length===0;if(E)(r.state==="new"||r.state==="gathering")&&(r.state="completed");else{r.state==="new"&&(r.state="gathering"),u.component=1,u.ufrag=r.getLocalParameters().usernameFragment;var f=c.writeCandidate(u);s.candidate=Object.assign(s.candidate,c.parseCandidate(f)),s.candidate.candidate=f,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var p=c.getMediaSections(a._localDescription.sdp);E?p[s.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:p[s.candidate.sdpMLineIndex]+="a="+s.candidate.candidate+`\r
`,a._localDescription.sdp=c.getDescription(a._localDescription.sdp)+p.join("");var k=a.transceivers.every(function(S){return S.iceGatherer&&S.iceGatherer.state==="completed"});a.iceGatheringState!=="gathering"&&(a.iceGatheringState="gathering",a._emitGatheringStateChange()),E||a._dispatchEvent("icecandidate",s),k&&(a._dispatchEvent("icecandidate",new Event("icecandidate")),a.iceGatheringState="complete",a._emitGatheringStateChange())}},o.setTimeout(function(){n.forEach(function(l){r.onlocalcandidate(l)})},0)}},i.prototype._createIceAndDtlsTransports=function(){var e=this,t=new o.RTCIceTransport(null);t.onicestatechange=function(){e._updateIceConnectionState(),e._updateConnectionState()};var a=new o.RTCDtlsTransport(t);return a.ondtlsstatechange=function(){e._updateConnectionState()},a.onerror=function(){Object.defineProperty(a,"state",{value:"failed",writable:!0}),e._updateConnectionState()},{iceTransport:t,dtlsTransport:a}},i.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var a=this.transceivers[e].iceTransport;a&&(delete a.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},i.prototype._transceive=function(e,t,a){var r=x(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(r.encodings=e.sendEncodingParameters,r.rtcp={cname:c.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(r.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(r)),a&&e.rtpReceiver&&r.codecs.length>0&&(e.kind==="video"&&e.recvEncodingParameters&&m<15019&&e.recvEncodingParameters.forEach(function(n){delete n.rtx}),e.recvEncodingParameters.length?r.encodings=e.recvEncodingParameters:r.encodings=[{}],r.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(r.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(r.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(r))},i.prototype.setLocalDescription=function(e){var t=this;if(["offer","answer"].indexOf(e.type)===-1)return Promise.reject(C("TypeError",'Unsupported type "'+e.type+'"'));if(!Z("setLocalDescription",e.type,t.signalingState)||t._isClosed)return Promise.reject(C("InvalidStateError","Can not set local "+e.type+" in state "+t.signalingState));var a,r;if(e.type==="offer")a=c.splitSections(e.sdp),r=a.shift(),a.forEach(function(l,s){var u=c.parseRtpParameters(l);t.transceivers[s].localCapabilities=u}),t.transceivers.forEach(function(l,s){t._gather(l.mid,s)});else if(e.type==="answer"){a=c.splitSections(t._remoteDescription.sdp),r=a.shift();var n=c.matchPrefix(r,"a=ice-lite").length>0;a.forEach(function(l,s){var u=t.transceivers[s],E=u.iceGatherer,f=u.iceTransport,p=u.dtlsTransport,k=u.localCapabilities,S=u.remoteCapabilities,y=c.isRejected(l)&&c.matchPrefix(l,"a=bundle-only").length===0;if(!y&&!u.rejected){var w=c.getIceParameters(l,r),b=c.getDtlsParameters(l,r);n&&(b.role="server"),(!t.usingBundle||s===0)&&(t._gather(u.mid,s),f.state==="new"&&f.start(E,w,n?"controlling":"controlled"),p.state==="new"&&p.start(b));var P=x(k,S);t._transceive(u,P.codecs.length>0,!1)}})}return t._localDescription={type:e.type,sdp:e.sdp},e.type==="offer"?t._updateSignalingState("have-local-offer"):t._updateSignalingState("stable"),Promise.resolve()},i.prototype.setRemoteDescription=function(e){var t=this;if(["offer","answer"].indexOf(e.type)===-1)return Promise.reject(C("TypeError",'Unsupported type "'+e.type+'"'));if(!Z("setRemoteDescription",e.type,t.signalingState)||t._isClosed)return Promise.reject(C("InvalidStateError","Can not set remote "+e.type+" in state "+t.signalingState));var a={};t.remoteStreams.forEach(function(f){a[f.id]=f});var r=[],n=c.splitSections(e.sdp),l=n.shift(),s=c.matchPrefix(l,"a=ice-lite").length>0,u=c.matchPrefix(l,"a=group:BUNDLE ").length>0;t.usingBundle=u;var E=c.matchPrefix(l,"a=ice-options:")[0];return E?t.canTrickleIceCandidates=E.substr(14).split(" ").indexOf("trickle")>=0:t.canTrickleIceCandidates=!1,n.forEach(function(f,p){var k=c.splitLines(f),S=c.getKind(f),y=c.isRejected(f)&&c.matchPrefix(f,"a=bundle-only").length===0,w=k[0].substr(2).split(" ")[2],b=c.getDirection(f,l),P=c.parseMsid(f),z=c.getMid(f)||c.generateIdentifier();if(y||S==="application"&&(w==="DTLS/SCTP"||w==="UDP/DTLS/SCTP")){t.transceivers[p]={mid:z,kind:S,protocol:w,rejected:!0};return}!y&&t.transceivers[p]&&t.transceivers[p].rejected&&(t.transceivers[p]=t._createTransceiver(S,!0));var d,q,A,F,D,B,I,N,G,K=c.parseRtpParameters(f),M,U;y||(M=c.getIceParameters(f,l),U=c.getDtlsParameters(f,l),U.role="client"),I=c.parseRtpEncodingParameters(f);var Q=c.parseRtcpParameters(f),W=c.matchPrefix(f,"a=end-of-candidates",l).length>0,O=c.matchPrefix(f,"a=candidate:").map(function(_){return c.parseCandidate(_)}).filter(function(_){return _.component===1});if((e.type==="offer"||e.type==="answer")&&!y&&u&&p>0&&t.transceivers[p]&&(t._disposeIceAndDtlsTransports(p),t.transceivers[p].iceGatherer=t.transceivers[0].iceGatherer,t.transceivers[p].iceTransport=t.transceivers[0].iceTransport,t.transceivers[p].dtlsTransport=t.transceivers[0].dtlsTransport,t.transceivers[p].rtpSender&&t.transceivers[p].rtpSender.setTransport(t.transceivers[0].dtlsTransport),t.transceivers[p].rtpReceiver&&t.transceivers[p].rtpReceiver.setTransport(t.transceivers[0].dtlsTransport)),e.type==="offer"&&!y){d=t.transceivers[p]||t._createTransceiver(S),d.mid=z,d.iceGatherer||(d.iceGatherer=t._createIceGatherer(p,u)),O.length&&d.iceTransport.state==="new"&&(W&&(!u||p===0)?d.iceTransport.setRemoteCandidates(O):O.forEach(function(_){V(d.iceTransport,_)})),N=o.RTCRtpReceiver.getCapabilities(S),m<15019&&(N.codecs=N.codecs.filter(function(_){return _.name!=="rtx"})),B=d.sendEncodingParameters||[{ssrc:(2*p+2)*1001}];var J=!1;if(b==="sendrecv"||b==="sendonly"){if(J=!d.rtpReceiver,D=d.rtpReceiver||new o.RTCRtpReceiver(d.dtlsTransport,S),J){var j;G=D.track,P&&P.stream==="-"||(P?(a[P.stream]||(a[P.stream]=new o.MediaStream,Object.defineProperty(a[P.stream],"id",{get:function(){return P.stream}})),Object.defineProperty(G,"id",{get:function(){return P.track}}),j=a[P.stream]):(a.default||(a.default=new o.MediaStream),j=a.default)),j&&(T(G,j),d.associatedRemoteMediaStreams.push(j)),r.push([G,D,j])}}else d.rtpReceiver&&d.rtpReceiver.track&&(d.associatedRemoteMediaStreams.forEach(function(_){var X=_.getTracks().find(function(L){return L.id===d.rtpReceiver.track.id});X&&g(X,_)}),d.associatedRemoteMediaStreams=[]);d.localCapabilities=N,d.remoteCapabilities=K,d.rtpReceiver=D,d.rtcpParameters=Q,d.sendEncodingParameters=B,d.recvEncodingParameters=I,t._transceive(t.transceivers[p],!1,J)}else if(e.type==="answer"&&!y){d=t.transceivers[p],q=d.iceGatherer,A=d.iceTransport,F=d.dtlsTransport,D=d.rtpReceiver,B=d.sendEncodingParameters,N=d.localCapabilities,t.transceivers[p].recvEncodingParameters=I,t.transceivers[p].remoteCapabilities=K,t.transceivers[p].rtcpParameters=Q,O.length&&A.state==="new"&&((s||W)&&(!u||p===0)?A.setRemoteCandidates(O):O.forEach(function(_){V(d.iceTransport,_)})),(!u||p===0)&&(A.state==="new"&&A.start(q,M,"controlling"),F.state==="new"&&F.start(U));var $=x(d.localCapabilities,d.remoteCapabilities),H=$.codecs.filter(function(_){return _.name.toLowerCase()==="rtx"}).length;!H&&d.sendEncodingParameters[0].rtx&&delete d.sendEncodingParameters[0].rtx,t._transceive(d,b==="sendrecv"||b==="recvonly",b==="sendrecv"||b==="sendonly"),D&&(b==="sendrecv"||b==="sendonly")?(G=D.track,P?(a[P.stream]||(a[P.stream]=new o.MediaStream),T(G,a[P.stream]),r.push([G,D,a[P.stream]])):(a.default||(a.default=new o.MediaStream),T(G,a.default),r.push([G,D,a.default]))):delete d.rtpReceiver}}),t._dtlsRole===void 0&&(t._dtlsRole=e.type==="offer"?"active":"passive"),t._remoteDescription={type:e.type,sdp:e.sdp},e.type==="offer"?t._updateSignalingState("have-remote-offer"):t._updateSignalingState("stable"),Object.keys(a).forEach(function(f){var p=a[f];if(p.getTracks().length){if(t.remoteStreams.indexOf(p)===-1){t.remoteStreams.push(p);var k=new Event("addstream");k.stream=p,o.setTimeout(function(){t._dispatchEvent("addstream",k)})}r.forEach(function(S){var y=S[0],w=S[1];p.id===S[2].id&&R(t,y,w,[p])})}}),r.forEach(function(f){f[2]||R(t,f[0],f[1],[])}),o.setTimeout(function(){!(t&&t.transceivers)||t.transceivers.forEach(function(f){f.iceTransport&&f.iceTransport.state==="new"&&f.iceTransport.getRemoteCandidates().length>0&&f.iceTransport.addRemoteCandidate({})})},4e3),Promise.resolve()},i.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},i.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},i.prototype._maybeFireNegotiationNeeded=function(){var e=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,o.setTimeout(function(){if(e.needNegotiation){e.needNegotiation=!1;var t=new Event("negotiationneeded");e._dispatchEvent("negotiationneeded",t)}},0))},i.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(r){r.iceTransport&&!r.rejected&&t[r.iceTransport.state]++}),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var a=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",a)}},i.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(r){r.iceTransport&&r.dtlsTransport&&!r.rejected&&(t[r.iceTransport.state]++,t[r.dtlsTransport.state]++)}),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var a=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",a)}},i.prototype.createOffer=function(){var e=this;if(e._isClosed)return Promise.reject(C("InvalidStateError","Can not call createOffer after close"));var t=e.transceivers.filter(function(s){return s.kind==="audio"}).length,a=e.transceivers.filter(function(s){return s.kind==="video"}).length,r=arguments[0];if(r){if(r.mandatory||r.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");r.offerToReceiveAudio!==void 0&&(r.offerToReceiveAudio===!0?t=1:r.offerToReceiveAudio===!1?t=0:t=r.offerToReceiveAudio),r.offerToReceiveVideo!==void 0&&(r.offerToReceiveVideo===!0?a=1:r.offerToReceiveVideo===!1?a=0:a=r.offerToReceiveVideo)}for(e.transceivers.forEach(function(s){s.kind==="audio"?(t--,t<0&&(s.wantReceive=!1)):s.kind==="video"&&(a--,a<0&&(s.wantReceive=!1))});t>0||a>0;)t>0&&(e._createTransceiver("audio"),t--),a>0&&(e._createTransceiver("video"),a--);var n=c.writeSessionBoilerplate(e._sdpSessionId,e._sdpSessionVersion++);e.transceivers.forEach(function(s,u){var E=s.track,f=s.kind,p=s.mid||c.generateIdentifier();s.mid=p,s.iceGatherer||(s.iceGatherer=e._createIceGatherer(u,e.usingBundle));var k=o.RTCRtpSender.getCapabilities(f);m<15019&&(k.codecs=k.codecs.filter(function(y){return y.name!=="rtx"})),k.codecs.forEach(function(y){y.name==="H264"&&y.parameters["level-asymmetry-allowed"]===void 0&&(y.parameters["level-asymmetry-allowed"]="1"),s.remoteCapabilities&&s.remoteCapabilities.codecs&&s.remoteCapabilities.codecs.forEach(function(w){y.name.toLowerCase()===w.name.toLowerCase()&&y.clockRate===w.clockRate&&(y.preferredPayloadType=w.payloadType)})}),k.headerExtensions.forEach(function(y){var w=s.remoteCapabilities&&s.remoteCapabilities.headerExtensions||[];w.forEach(function(b){y.uri===b.uri&&(y.id=b.id)})});var S=s.sendEncodingParameters||[{ssrc:(2*u+1)*1001}];E&&m>=15019&&f==="video"&&!S[0].rtx&&(S[0].rtx={ssrc:S[0].ssrc+1}),s.wantReceive&&(s.rtpReceiver=new o.RTCRtpReceiver(s.dtlsTransport,f)),s.localCapabilities=k,s.sendEncodingParameters=S}),e._config.bundlePolicy!=="max-compat"&&(n+="a=group:BUNDLE "+e.transceivers.map(function(s){return s.mid}).join(" ")+`\r
`),n+=`a=ice-options:trickle\r
`,e.transceivers.forEach(function(s,u){n+=Y(s,s.localCapabilities,"offer",s.stream,e._dtlsRole),n+=`a=rtcp-rsize\r
`,s.iceGatherer&&e.iceGatheringState!=="new"&&(u===0||!e.usingBundle)&&(s.iceGatherer.getLocalCandidates().forEach(function(E){E.component=1,n+="a="+c.writeCandidate(E)+`\r
`}),s.iceGatherer.state==="completed"&&(n+=`a=end-of-candidates\r
`))});var l=new o.RTCSessionDescription({type:"offer",sdp:n});return Promise.resolve(l)},i.prototype.createAnswer=function(){var e=this;if(e._isClosed)return Promise.reject(C("InvalidStateError","Can not call createAnswer after close"));if(!(e.signalingState==="have-remote-offer"||e.signalingState==="have-local-pranswer"))return Promise.reject(C("InvalidStateError","Can not call createAnswer in signalingState "+e.signalingState));var t=c.writeSessionBoilerplate(e._sdpSessionId,e._sdpSessionVersion++);e.usingBundle&&(t+="a=group:BUNDLE "+e.transceivers.map(function(n){return n.mid}).join(" ")+`\r
`),t+=`a=ice-options:trickle\r
`;var a=c.getMediaSections(e._remoteDescription.sdp).length;e.transceivers.forEach(function(n,l){if(!(l+1>a)){if(n.rejected){n.kind==="application"?n.protocol==="DTLS/SCTP"?t+=`m=application 0 DTLS/SCTP 5000\r
`:t+="m=application 0 "+n.protocol+` webrtc-datachannel\r
`:n.kind==="audio"?t+=`m=audio 0 UDP/TLS/RTP/SAVPF 0\r
a=rtpmap:0 PCMU/8000\r
`:n.kind==="video"&&(t+=`m=video 0 UDP/TLS/RTP/SAVPF 120\r
a=rtpmap:120 VP8/90000\r
`),t+=`c=IN IP4 0.0.0.0\r
a=inactive\r
a=mid:`+n.mid+`\r
`;return}if(n.stream){var s;n.kind==="audio"?s=n.stream.getAudioTracks()[0]:n.kind==="video"&&(s=n.stream.getVideoTracks()[0]),s&&m>=15019&&n.kind==="video"&&!n.sendEncodingParameters[0].rtx&&(n.sendEncodingParameters[0].rtx={ssrc:n.sendEncodingParameters[0].ssrc+1})}var u=x(n.localCapabilities,n.remoteCapabilities),E=u.codecs.filter(function(f){return f.name.toLowerCase()==="rtx"}).length;!E&&n.sendEncodingParameters[0].rtx&&delete n.sendEncodingParameters[0].rtx,t+=Y(n,u,"answer",n.stream,e._dtlsRole),n.rtcpParameters&&n.rtcpParameters.reducedSize&&(t+=`a=rtcp-rsize\r
`)}});var r=new o.RTCSessionDescription({type:"answer",sdp:t});return Promise.resolve(r)},i.prototype.addIceCandidate=function(e){var t=this,a;return e&&!(e.sdpMLineIndex!==void 0||e.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(r,n){if(t._remoteDescription)if(!e||e.candidate==="")for(var l=0;l<t.transceivers.length&&!(!t.transceivers[l].rejected&&(t.transceivers[l].iceTransport.addRemoteCandidate({}),a=c.getMediaSections(t._remoteDescription.sdp),a[l]+=`a=end-of-candidates\r
`,t._remoteDescription.sdp=c.getDescription(t._remoteDescription.sdp)+a.join(""),t.usingBundle));l++);else{var s=e.sdpMLineIndex;if(e.sdpMid){for(var u=0;u<t.transceivers.length;u++)if(t.transceivers[u].mid===e.sdpMid){s=u;break}}var E=t.transceivers[s];if(E){if(E.rejected)return r();var f=Object.keys(e.candidate).length>0?c.parseCandidate(e.candidate):{};if(f.protocol==="tcp"&&(f.port===0||f.port===9)||f.component&&f.component!==1)return r();if((s===0||s>0&&E.iceTransport!==t.transceivers[0].iceTransport)&&!V(E.iceTransport,f))return n(C("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();p.indexOf("a=")===0&&(p=p.substr(2)),a=c.getMediaSections(t._remoteDescription.sdp),a[s]+="a="+(f.type?p:"end-of-candidates")+`\r
`,t._remoteDescription.sdp=c.getDescription(t._remoteDescription.sdp)+a.join("")}else return n(C("OperationError","Can not add ICE candidate"))}else return n(C("InvalidStateError","Can not add ICE candidate without a remote description"));r()})},i.prototype.getStats=function(e){if(e&&e instanceof o.MediaStreamTrack){var t=null;if(this.transceivers.forEach(function(r){r.rtpSender&&r.rtpSender.track===e?t=r.rtpSender:r.rtpReceiver&&r.rtpReceiver.track===e&&(t=r.rtpReceiver)}),!t)throw C("InvalidAccessError","Invalid selector.");return t.getStats()}var a=[];return this.transceivers.forEach(function(r){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){r[n]&&a.push(r[n].getStats())})}),Promise.all(a).then(function(r){var n=new Map;return r.forEach(function(l){l.forEach(function(s){n.set(s.id,s)})}),n})};var v=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];v.forEach(function(e){var t=o[e];if(t&&t.prototype&&t.prototype.getStats){var a=t.prototype.getStats;t.prototype.getStats=function(){return a.apply(this).then(function(r){var n=new Map;return Object.keys(r).forEach(function(l){r[l].type=te(r[l]),n.set(l,r[l])}),n})}}});var h=["createOffer","createAnswer"];return h.forEach(function(e){var t=i.prototype[e];i.prototype[e]=function(){var a=arguments;return typeof a[0]=="function"||typeof a[1]=="function"?t.apply(this,[arguments[2]]).then(function(r){typeof a[0]=="function"&&a[0].apply(null,[r])},function(r){typeof a[1]=="function"&&a[1].apply(null,[r])}):t.apply(this,arguments)}}),h=["setLocalDescription","setRemoteDescription","addIceCandidate"],h.forEach(function(e){var t=i.prototype[e];i.prototype[e]=function(){var a=arguments;return typeof a[1]=="function"||typeof a[2]=="function"?t.apply(this,arguments).then(function(){typeof a[1]=="function"&&a[1].apply(null)},function(r){typeof a[2]=="function"&&a[2].apply(null,[r])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=i.prototype[e];i.prototype[e]=function(){var a=arguments;return typeof a[1]=="function"?t.apply(this,arguments).then(function(){typeof a[1]=="function"&&a[1].apply(null)}):t.apply(this,arguments)}}),i};export{ne as r};
