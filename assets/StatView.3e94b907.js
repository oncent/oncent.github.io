import{a as K}from"./vue-router.c17ffd82.js";import{d as h}from"./dayjs.73288a1b.js";import{_ as L}from"./DateTime.vue_vue_type_script_setup_true_lang.1bb77d31.js";import{m as j,r as y,c as _,o as J,w as N,J as Q,q as k,t as D,v as c,z as T,G as Y,F as Z,E as H,u as b,k as S,P as X,Q as ee,n as te,R as se,A as R,U as ae,B,V as ne,W as U}from"./@vue.6b771be9.js";import{_ as oe,i as le,B as E,u as W,m as re,g as ie,t as ce,d as ue,E as de}from"./index.e955a77d.js";import{a as me}from"./@vueuse.3609b986.js";import{u as pe,i as fe,a as ve,b as he,c as xe,d as ye,e as ge,f as _e,g as we,h as $e,j as Ce,k as ke,l as Me}from"./echarts.f6f9045b.js";import{_ as P}from"./Select.vue_vue_type_style_index_0_lang.094ef98b.js";import{u as be}from"./useLimitSelect.b6e917fd.js";import"./complex.js.3b936b7b.js";import"./dexie.a92c4e2b.js";import"./uuid.fbc3d34b.js";import"./vue-i18n.a532ecf1.js";import"./@intlify.03657722.js";import"./zrender.271abeed.js";const Ye=o=>(X("data-v-b730748c"),o=o(),ee(),o),De={class:"flex flex-col items-center"},Se={class:"flex justify-around rounded-full items-center max-w-300px w-full"},Te=["onClick"],Ve={key:1,class:"flex justify-around items-center w-full h-12"},Ie=Ye(()=>c("div",null,"-",-1)),Ne=j({__name:"DateRangeSelector",props:{start:{default:h().format("YYYY-MM-DD")},end:{default:h().format("YYYY-MM-DD")},date:null,initialType:{default:"month"}},emits:["change"],setup(o,{emit:a}){const s=o,n=()=>{const p=h(s.start).startOf("year"),i=h(s.end).startOf("year"),r=p.year(),v=i.year();return{type:"year",times:Array.from({length:Math.abs(v-r)+1},(d,m)=>({name:`${r+m}`,range:[h(`${r+m}`),h(`${r+m}`).endOf("year")]}))}},t=()=>{const p=h(s.end).startOf("month"),i=h(s.start).startOf("month"),r=Math.abs(p.diff(i,"month"))+1,v=Array.from({length:r},(d,m)=>{const $=i.add(m,"month");return{name:$.format("YYYY-MM"),range:[$,$.endOf("month")]}});return{type:"month",times:v}},e=y(s.initialType),l=_(()=>e.value==="year"?n().times:e.value==="month"?t().times:[{name:"",range:[h(s.start),h(s.end)]}]),f=y(),x=p=>{var v;const i=h(p),r=[...l.value].reverse().findIndex(d=>i.isAfter(d.range[0]));return{index:r,time:(v=l.value[r])!=null?v:l.value[0]}},C=y(),w=y(h(s.start)),u=y(h(s.end)),g=()=>{const{index:p,time:i}=x(w.value);M(i,p,!1)};J(()=>{g()}),N(e,p=>{p!=="custom"&&te(()=>{g()})});const M=(p,i,r=!0)=>{var v;C.value=p,f.value&&((v=document.querySelector(`.slider-item-${i}`))==null||v.scrollIntoView({block:"center",inline:"center",behavior:r?"smooth":void 0})),a("change",...C.value.range)};return Q(()=>{w.value&&u.value&&a("change",w.value,u.value)}),(p,i)=>(k(),D("div",De,[c("div",Se,[c("div",{class:T(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="year"}]),onClick:i[0]||(i[0]=r=>e.value="year")},Y(p.$t("year")),3),c("div",{class:T(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="month"}]),onClick:i[1]||(i[1]=r=>e.value="month")},Y(p.$t("month")),3),c("div",{class:T(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="custom"}]),onClick:i[2]||(i[2]=r=>e.value="custom")},Y(p.$t("custom")),3)]),e.value!=="custom"?(k(),D("div",{class:"slider w-full h-12 flex items-center overflow-x-scroll snap snap-always snap-mandatory snap-x",key:e.value,ref_key:"sliderEl",ref:f},[(k(!0),D(Z,null,H(b(l),(r,v)=>{var d;return k(),D("div",{key:r.name,class:T(["whitespace-nowrap mx-2 px-2 rounded-sm snap-center text-sm",[{"bg-stone-700 text-white":r.name===((d=C.value)==null?void 0:d.name)},`slider-item-${v}`]]),onClick:m=>M(r,v)},Y(r.name),11,Te)}),128))])):(k(),D("div",Ve,[S(L,{modelValue:w.value,"onUpdate:modelValue":i[3]||(i[3]=r=>w.value=r),"display-formatter":"YYYY-MM-DD",class:"text-sm buttoned rounded px-2"},null,8,["modelValue"]),Ie,S(L,{modelValue:u.value,"onUpdate:modelValue":i[4]||(i[4]=r=>u.value=r),"display-formatter":"YYYY-MM-DD",class:"text-sm buttoned rounded px-2"},null,8,["modelValue"])]))]))}});const Ee=oe(Ne,[["__scopeId","data-v-b730748c"]]);pe([fe,ve,he,xe,ye,ge,_e,we,$e,Ce,ke]);const q=j({__name:"Chart",props:{option:null,onClick:null},emits:["click"],setup(o,{emit:a}){const s=o,n=y(),{width:t}=me();return J(()=>{const e=Me(n.value);e.setOption(s.option),N(()=>s.option,()=>{e.setOption(s.option)}),se(()=>{e.dispose()}),N(t,()=>{e.resize()}),e.on("click",l=>{a("click",l)})}),(e,l)=>(k(),D("div",{ref_key:"chartRef",ref:n},null,512))}}),I=o=>{let a=0;try{let t=Number(o).toString().toUpperCase();if(t.split("E").length===2){var s=!1;t.split(".").length===2&&(t=t.split(".")[1],parseInt(t.split("E")[0])!==0&&(s=!0));let e=t.split("E");s&&(a=e[0].length),a-=parseInt(e[1])}else t.split(".").length===2&&parseInt(t.split(".")[1])!==0&&(a=t.split(".")[1].length)}catch(n){throw n}finally{return(isNaN(a)||a<0)&&(a=0),a}},z=o=>{let a=Number(o),s=I(o),n=o.toString().toUpperCase();return n.split("E").length===2?a=Math.round(a*Math.pow(10,s)):a=Number(n.replace(".","")),a},G=(o,a,s,n)=>{let t=0;switch(o){case"add":t=a+s;break;case"sub":t=a-s;break;case"div":t=a/s;break;case"mul":t=a*s;break}return Math.abs(n-t)>1?t:n},F=(o,a)=>{const s=Number(o),n=Number(a);var t=0,e=s.toString(),l=n.toString();try{t+=I(e)}catch{}try{t+=I(l)}catch{}var f=z(e)*z(l)/Math.pow(10,t);return G("mul",s,n,f)},V=(o,a)=>{const s=Number(o),n=Number(a);let t,e,l;try{t=I(s)+1}catch{t=0}try{e=I(n)+1}catch{e=0}l=Math.pow(10,Math.max(t,e));var f=(F(s,l)+F(n,l))/l;return G("add",s,n,f)},{list:je}=W(),Re=["income","expenses","sum"],Be=(o,a)=>{const s=_(()=>je.value.filter(t=>le(t,o.value,a.value)));return _(()=>{const t=new Map;return s.value.forEach(e=>{var w,u;const l=h.unix(e.time).format("YYYY-MM-DD"),f=(()=>(t.has(e.creatorId)||t.set(e.creatorId,{expenses:new Map,income:new Map,sum:new Map,incomeCategories:new Map,expenseCategories:new Map}),t.get(e.creatorId)))(),x=e.type===E.Expenses?f.expenses:f.income;x.set(l,V((w=x.get(l))!=null?w:0,e.money));const C=e.type===E.Expenses?f.expenseCategories:f.incomeCategories;C.set(e.categoryId,V((u=C.get(e.categoryId))!=null?u:0,e.money))}),t})},O=(o,a,s)=>{const n=a.filter(e=>o.has(e.id)).map(e=>{switch(s){case"expenses":return o.get(e.id).expenseCategories;case"income":return o.get(e.id).incomeCategories;case"sum":return[o.get(e.id).expenseCategories,o.get(e.id).incomeCategories];default:return o.get(e.id).expenseCategories}}).flat();return[...re(...n).entries()].map(([e,l])=>{const f=ie(e);return{total:l,name:f.name,category:ce(f.name)}})},Oe=(o,a,s)=>{const n=a.filter(l=>o.has(l.id)).map(l=>o.get(l.id)),t=[...new Set(n.map(l=>[...l[s].keys()]).flat())],e=n.map(l=>[...l[s].values()]);return{dates:t,values:e}},Ue={class:"w-full flex flex-col items-center"},Ae={class:"flex items-center shadow-inner rounded-full p-1"},Le=c("div",{class:"transform translate-y-[-30%]"},[c("i",{class:"icon-chart icon-xs"})],-1),Pe=[Le],qe={class:"flex w-full px-2 items-center justify-between"},ze={class:"shadow buttoned px-4 max-w-[160px] rounded-full h-full truncate mx-2 py-1 flex items-center"},Fe=c("i",{class:"icon-smile-no-mouth icon-xs"},null,-1),Je={class:"px-2"},We={class:"flex items-center"},Ge={class:"rounded buttoned h-full truncate flex items-center px-2"},Ke=c("div",{class:"pr-2"},[c("i",{class:"icon-arrows-exchange-alt-v icon-xs"})],-1),Qe=j({__name:"IncomeChart",props:{statistic:null},setup(o,{expose:a}){const s=o,n=y("expenses"),t=y([]),{allUsers:e}=ue();be(t,e);const l=y("pie"),f=_(()=>O(s.statistic,t.value,"expenses")),x=_(()=>O(s.statistic,t.value,"income")),C=_(()=>O(s.statistic,t.value,"sum")),w=_(()=>({expenses:f.value.reduce((d,m)=>V(d,m.total),0),income:x.value.reduce((d,m)=>V(d,m.total),0),sum:C.value.reduce((d,m)=>V(d,m.total),0)})),u=_(()=>{switch(n.value){case"expenses":return f.value;case"income":return x.value;case"sum":return C.value;default:return[]}}),g=y(""),M=y(""),p=d=>{d.data&&(g.value=`${d.data.category}: ${d.data.total}`,M.value=d.data.name)};N(n,()=>{g.value="",M.value=""}),a({currentCategory:M,currentType:n,selectedUsers:t});const i=_(()=>({title:{text:g.value,left:"center",top:"center"},dataset:{dimensions:["category","total"],source:ne(u.value)},xAxis:{type:"category",show:!1},yAxis:{},series:[{type:"pie",radius:["50%","70%"],stillShowZeroSum:!1}]})),r=_(()=>Oe(s.statistic,e.value,n.value)),v=_(()=>({xAxis:{type:"time",data:r.value.dates},yAxis:{type:"value"},series:r.value.values.map(m=>({data:m,type:"line",stack:"x"}))}));return(d,m)=>(k(),D("div",Ue,[c("div",Ae,[c("div",{class:T(["flex justify-center items-center w-12 h-6 rounded-full",{"bg-stone-700 text-white":l.value==="pie"}]),onClick:m[0]||(m[0]=$=>l.value="pie")},Pe,2)]),(k(),R(ae,null,[l.value==="pie"?(k(),R(q,{key:0,class:"w-full aspect-square max-h-300px",option:b(i),onClick:p},null,8,["option"])):(k(),R(q,{key:1,class:"w-full aspect-square max-h-300px",option:b(v)},null,8,["option"]))],1024)),c("div",qe,[S(P,{modelValue:t.value,"onUpdate:modelValue":m[1]||(m[1]=$=>t.value=$),list:b(e),multiple:"","value-key":"id",placement:"bottom-left"},{default:B(({allSelected:$})=>[c("div",ze,[Fe,c("div",Je,Y($?d.$t("all"):t.value.length===0?"None":t.value.map(A=>A.name).join(",")),1)])]),_:1},8,["modelValue","list"]),c("div",We,[S(P,{modelValue:n.value,"onUpdate:modelValue":m[2]||(m[2]=$=>n.value=$),list:b(Re)},{option:B(({item:$})=>[U(Y(d.$t($)),1)]),default:B(()=>[c("div",Ge,[Ke,U(" "+Y(d.$t(n.value))+": ",1)])]),_:1},8,["modelValue","list"]),c("div",null,Y(b(w)[n.value]),1)])])]))}}),Ze={class:"w-full h-full flex justify-center"},He={class:"h-full w-full mx-2 max-w-[600px] flex flex-col"},Xe={class:"filter w-full m-1 p-2"},et={class:"flex p-2 justify-end items-center"},tt=c("div",{class:"flex items-center justify-center"},[c("i",{class:"icon-chevron-right"})],-1),xt=j({__name:"StatView",setup(o){const{list:a}=W(),s=_(()=>{const u=a.value.at(-1);if(u)return h.unix(u.time)}),n=_(()=>{const u=a.value.at(0);if(u)return h.unix(u.time)}),t=y(),e=y(),l=(u,g)=>{t.value=u,e.value=g},f=Be(t,e),x=y(),C=K(),w=()=>{var p;const{selectedUsers:u,currentType:g,currentCategory:M}=(p=x.value)!=null?p:{};C.push({name:"search",query:{filters:JSON.stringify({type:g==="expenses"?E.Expenses:g==="income"?E.Income:void 0,users:u==null?void 0:u.map(i=>i.id),categories:M?[M].map(i=>{var r;return(r=de.find(v=>v.name===i))==null?void 0:r.id}):void 0,start:t.value,end:e.value})}})};return(u,g)=>(k(),D("div",Ze,[c("div",He,[c("div",Xe,[S(Ee,{start:b(s),end:b(n),onChange:l},null,8,["start","end"])]),c("div",null,[S(Qe,{ref_key:"chartRef",ref:x,statistic:b(f)},null,8,["statistic"])]),c("div",et,[c("div",{class:"flex buttoned rounded-full py-1 px-2 flex items-center",onClick:w},[U(Y(u.$t("see-details"))+" ",1),tt])])])]))}});export{xt as default};
