var z=Object.defineProperty;var K=(s,i,e)=>i in s?z(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var b=(s,i,e)=>(K(s,typeof i!="symbol"?i+"":i,e),e);import{m as U,q as w,A as Z,B as ee,v as c,G as E,t as I,k as A,r as R,R as te,c as ne,u as S,F as se,E as oe,V as ce,W as ae}from"./@vue.aa17ec7c.js";import{$ as P}from"./peerjs.faff7497.js";import{k as ie,m as D,t as h,n as B,o as _,M as v,d as W,p as re}from"./index.c78643dc.js";import{U as le}from"./UserAvatar.c27b6f55.js";import{d as O}from"./dayjs.8eec1a0d.js";import"./peerjs-js-binarypack.edcf3dbb.js";import"./webrtc-adapter.37c3a6f1.js";import"./rtcpeerconnection-shim.1d74cdf3.js";import"./sdp.c10b5003.js";import"./vue-router.835b731e.js";import"./dexie.a92c4e2b.js";import"./uuid.fbc3d34b.js";import"./@vueuse.9aab9800.js";import"./vue-i18n.bcf46dc7.js";import"./@intlify.03657722.js";const Y="promise canceled",k=s=>{let i=()=>{},e=()=>{};const t=l=>{e=l};return{start:(...l)=>{const p=s(t,...l),d=new Promise((u,T)=>{i=T});return Promise.race([p,d])},cancel:()=>{i(new Error(Y)),e()}}},G=s=>(s==null?void 0:s.message)===Y,de=(()=>{let s=0;return()=>(s+=1,s)})(),ue="DATA_SENDED",pe="DATA_ABORTED",me="DATA_NEXT_RECEIVED";class V extends EventTarget{constructor(e,t){super();b(this,"receivingCallback");this.connection=e,this.info=t,this.connection.on("data",o=>{var l;const n=o;switch(n.type){case 0:this.connection.send({type:2,data:n.id}),this.dispatchEvent(new CustomEvent(me,{detail:o})),(l=this.receivingCallback)==null||l.call(this,()=>n.data);break;case 2:this.dispatchEvent(new CustomEvent(ue,{detail:o}));break;case 1:this.dispatchEvent(new CustomEvent(pe,{detail:o}));break}})}send(e){return k(t=>new Promise((o,n)=>{const l=de();this.connection.send({type:0,data:e,id:l});let p=!1;t(()=>{this.connection.send({type:1,data:l}),p=!0});const d=u=>{if(p){n();return}u.type===2&&u.data===l&&(o(),this.connection.off("data",d)),u.type===1&&u.data===l&&(n(),this.connection.off("data",d))};this.connection.on("data",d);const r=()=>{n(),this.connection.off("error",r)};this.connection.on("error",r)}))}close(){this.connection.close()}reject(){this.connection.send({type:1}),this.connection.close()}onReceiving(e){this.receivingCallback=e}nextReceived(){return new Promise((e,t)=>{const o=n=>{n.type===0&&(e(n.data),this.connection.off("data",o)),n.type===1&&(t(),this.connection.off("data",o))};this.connection.on("data",o)})}}const L="CONNECTION_REQUEST",M="CONNECTION_ACCEPTED",N="CONNECTION_REJECT_ERROR",H="ERROR_CONNECTION_CANCELED",F="EVENT_USER_ACCEPT",j="EVENT_USER_REJECT",fe="EVENT_SENDER_CANCEL",ye=s=>(s==null?void 0:s.message)===N,he=s=>(s==null?void 0:s.message)===H;class x extends EventTarget{constructor(e,t){super();b(this,"peer");b(this,"connectionCallback");this.meta=e,this.peer=t?new P(t):new P,this.setPeer()}notifyUpdate(){this.dispatchEvent(new CustomEvent("update",{detail:this.save()}))}static fromStore(e,t){return t?new x(e,t.peerId):new x(e)}save(){return{peerId:this.peer.id}}connect(e){return k(t=>{let o,n;return t(()=>{o==null||o.close(),n==null||n.close()}),new Promise((p,d)=>{n=this.peer.connect(e,{metadata:{...this.meta,connectId:this.peer.id}}),n.once("open",()=>{n.send(L);const r=u=>{u.type===M&&(o=new V(n,{sender:{...this.meta,connectId:this.peer.id},receiver:{...u.metadata,connectId:e}}),p(o)),u.type===N&&d()};n.once("data",r)}),n.once("close",()=>d(new Error(N))),n.once("error",d)})})}disconnect(e){var t;(t=this.peer.getConnection(this.peer.id,e))==null||t.close()}onConnection(e){this.connectionCallback=e}setPeer(){this.peer.on("open",()=>{this.notifyUpdate(),this.dispatchEvent(new CustomEvent("ready"));const e=()=>new Promise((o,n)=>{this.addEventListener(F,()=>{o()},{once:!0}),this.addEventListener(j,()=>{n()},{once:!0}),this.addEventListener(fe,()=>{n()},{once:!0})});let t;this.peer.on("connection",async o=>{var r;let n=!1;o.once("close",()=>{n=!0});const l=e();o.once("data",async u=>{if(u===L)try{await l,n||(t=new V(o,{sender:{...this.meta,connectId:this.peer.id},receiver:{...o.metadata}}))}catch{o.send({type:N}),o.close()}});const p=async()=>{if(this.dispatchEvent(new CustomEvent(F)),await l,n)throw n=!1,new Error(H);return o.send({type:M,metadata:{...this.meta,connectId:this.peer.id}}),t},d=()=>{this.dispatchEvent(new CustomEvent(j)),n=!1};(r=this.connectionCallback)==null||r.call(this,o.metadata,p,d)})})}destroy(){this.peer.destroy()}}const Ee={class:"p-4 flex flex-col w-full h-full items-center"},_e={class:"flex-1 flex items-center"},ve=c("div",null,[c("i",{class:"icon-spinner"})],-1),Ce={class:"px-2"},we=U({__name:"SyncDialog",props:{syncing:{type:Boolean}},emits:["cancel"],setup(s,{emit:i}){const e=async()=>{await D({title:h("are-you-sure-to-cancel-syncing")}),i("cancel")};return(t,o)=>(w(),Z(ie,{visible:s.syncing,"custom-class":"sync-status-dialog"},{default:ee(()=>[c("div",Ee,[c("div",_e,[ve,c("div",Ce,E(t.$t("syncing")),1)]),c("button",{class:"buttoned px-4 py-2 rounded",onClick:e},E(t.$t("cancel")),1)])]),_:1},8,["visible"]))}});const Te={class:"flex justify-between items-center"},be={class:"flex items-center"},Ie={class:"flex flex-col justify-between px-2"},Ne={class:"text-xs text-stone-600"},xe={class:"flex items-center"},$e={class:"mx-1"},ge=["disabled"],Re={class:"mx-1 flex items-center"},Se=c("i",{class:"icon-close"},null,-1),Ae=[Se],De=U({__name:"SyncUser",props:{name:null,latestUpdate:null,autoSync:{type:Boolean},disabled:{type:Boolean}},emits:["sync","delete","update:autoSync"],setup(s){const i=e=>!e||e<0?h("not-sync"):O.unix(e).format("YYYY-MM-DD HH:mm:ss");return(e,t)=>(w(),I("div",Te,[c("div",be,[A(le,{name:s.name,size:"40px"},null,8,["name"]),c("div",Ie,[c("div",null,E(Boolean(s.name)?s.name:"untitled"),1),c("div",Ne,E(e.$t("last-sync"))+E(i(s.latestUpdate)),1)])]),c("div",xe,[c("div",$e,[c("button",{class:"buttoned shadow px-2 rounded cursor-not-allowed opacity-50 not-disabled:cursor-pointer not-disabled:opacity-100",disabled:s.disabled,onClick:t[0]||(t[0]=o=>e.$emit("sync"))},E(e.$t("sync")),9,ge)]),c("div",Re,[c("button",{class:"rounded buttoned",onClick:t[1]||(t[1]=o=>e.$emit("delete"))},Ae)])])]))}}),{addUserInfo:Oe,allUsers:Ue,updateUserInfo:ke}=W(),J=(s,i=!1)=>k(async e=>{try{const{receiver:t}=s.info,o=await B.bills.toArray(),{start:n,cancel:l}=s.send(o);e(l);const p=await(async()=>{if(i){const r=await s.nextReceived();return await n(),r}else{const[r,u]=await Promise.all([n(),s.nextReceived()]);return u}})(),d=Ue.value.find(r=>r.connectId===t.connectId);d?await ke(d.id,{name:t.name,latestTransferTime:O().unix(),connectId:t.connectId}):await Oe({id:t.userId,name:t.name,latestTransferTime:O().unix(),connectId:t.connectId}),await B.addNewBillTable(t.userId,p),await new Promise(r=>setTimeout(()=>{r()},500)),s.close(),_({type:v.Success,content:h("sync-success")})}catch(t){G(t)||_({type:v.Error,content:h("something-wrong-please-try-again")})}}),Pe=async s=>navigator.clipboard.writeText(s),Be={class:"flex flex-col divide-y"},Ve={class:"flex flex-col items-center py-2 pb-4"},Le={class:"py-2"},Me={class:"flex justify-center"},Fe={class:"allow-select px-2 bg-stone-200 rounded flex items-center text-center text-stone-800"},je=c("i",{class:"icon-copy"},null,-1),Je=[je],We={class:"pb-4"},Ye={class:"p-2 pb-4"},Ge={class:"flex justify-center py-2"},He={class:"w-[80%] flex pt-2"},Qe=["placeholder"],Xe=["disabled"],pt=U({__name:"DataSync",setup(s){const{userInfo:i,allUsers:e,setMyInfo:t,removeUserInfo:o}=W(),n=x.fromStore({name:i.value.name,userId:i.value.id},{peerId:i.value.connectId});n.addEventListener("update",a=>{const f=a.detail;t({connectId:f.peerId})});const l=R(!1);n.addEventListener("ready",()=>{l.value=!0}),te(()=>{n.destroy()});const p=ne(()=>e.value.filter(({me:a})=>!a).map(a=>({connectId:a.connectId,latestTransferTime:a.latestTransferTime,meta:{name:a.name,userId:a.id}})));let d;const r=R(!1),u=async a=>{const{start:f,cancel:m}=n.connect(a);d=m,r.value=!0;try{const y=await f(),{start:$,cancel:g}=J(y);d=g,await $()}catch(y){G(y)||ye(y)&&_({type:v.Error,content:h("connection-rejected")})}r.value=!1},T=()=>{d==null||d(),r.value=!1},C=R(""),Q=()=>{C.value&&p.value.every(a=>a.connectId!==C.value)&&u(C.value)},X=async a=>{await D({title:h("are-you-sure-to-delete-this-will-delete-all-record-created-by-the-user")}),await re(a),await o(a),_({content:h("delete-user-success"),type:v.Success})};n.onConnection(async(a,f,m)=>{try{await D({title:`${a.name} ${h("wants-to-sync-data-with-you-accepted")}`}),r.value=!0;const y=await f(),{start:$,cancel:g}=J(y,!0);d=g,await $()}catch(y){if(he(y)){_({type:v.Warning,content:h("connection-was-canceled")});return}m()}r.value=!1});const q=async a=>{!a||(await Pe(a),_({content:h("copy-code-successfully"),type:v.Success}))};return(a,f)=>(w(),I("div",Be,[c("div",Ve,[c("div",Le,E(a.$t("your-code")),1),c("div",Me,[c("div",Fe,E(S(i).connectId),1),c("button",{class:"buttoned rounded mx-2 px-4 py-2",onClick:f[0]||(f[0]=m=>q(S(i).connectId))},Je)])]),c("div",We,[c("div",Ye,E(a.$t("shared-users")),1),(w(!0),I(se,null,oe(S(p),m=>(w(),I("div",{key:m.connectId,class:"px-2"},[A(De,{name:m.meta.name,"latest-update":m.latestTransferTime,"auto-sync":!1,disabled:!l.value,onSync:y=>u(m.connectId),onDelete:y=>X(m.meta.userId)},null,8,["name","latest-update","disabled","onSync","onDelete"])]))),128))]),c("div",Ge,[c("div",He,[ce(c("input",{"onUpdate:modelValue":f[1]||(f[1]=m=>C.value=m),placeholder:a.$t("paste-your-friends-code-here"),class:"border border-stone-600 rounded h-full mr-1 flex-1 px-1"},null,8,Qe),[[ae,C.value]]),c("button",{class:"not-disabled:bg-stone-900 text-white rounded px-2 py-1 bg-stone-200",disabled:!l.value,onClick:Q},E(a.$t("add-friends")),9,Xe)])]),A(we,{syncing:r.value,onCancel:T},null,8,["syncing"])]))}});export{pt as default};
