import{a as K}from"./vue-router.c17ffd82.js";import{d as v}from"./dayjs.73288a1b.js";import{_ as L}from"./DateTime.vue_vue_type_script_setup_true_lang.1bb77d31.js";import{m as j,r as y,c as _,o as J,w as S,J as Q,q as C,t as D,v as c,z as V,G as Y,F as Z,E as H,u as b,k as T,P as X,Q as ee,n as te,R as se,A as R,U as ae,B as O,V as ne,W as A}from"./@vue.6b771be9.js";import{_ as oe,i as le,B as E,u as W,m as re,g as ie,t as ce,d as ue}from"./index.10cbdfce.js";import{a as de}from"./@vueuse.3609b986.js";import{u as me,i as pe,a as fe,b as ve,c as he,d as xe,e as ye,f as ge,g as _e,h as we,j as $e,k as ke,l as Ce}from"./echarts.f6f9045b.js";import{_ as P}from"./Select.vue_vue_type_style_index_0_lang.1ef1b673.js";import"./complex.js.3b936b7b.js";import"./dexie.a92c4e2b.js";import"./uuid.fbc3d34b.js";import"./vue-i18n.a532ecf1.js";import"./@intlify.03657722.js";import"./zrender.271abeed.js";const Me=o=>(X("data-v-b730748c"),o=o(),ee(),o),be={class:"flex flex-col items-center"},Ye={class:"flex justify-around rounded-full items-center max-w-300px w-full"},De=["onClick"],Se={key:1,class:"flex justify-around items-center w-full h-12"},Te=Me(()=>c("div",null,"-",-1)),Ve=j({__name:"DateRangeSelector",props:{start:{default:v().format("YYYY-MM-DD")},end:{default:v().format("YYYY-MM-DD")},date:null,initialType:{default:"month"}},emits:["change"],setup(o,{emit:a}){const s=o,n=()=>{const p=v(s.start).startOf("year"),i=v(s.end).startOf("year"),r=p.year(),x=i.year();return{type:"year",times:Array.from({length:Math.abs(x-r)+1},(d,m)=>({name:`${r+m}`,range:[v(`${r+m}`),v(`${r+m}`).endOf("year")]}))}},t=()=>{const p=v(s.end).startOf("month"),i=v(s.start).startOf("month"),r=Math.abs(p.diff(i,"month"))+1,x=Array.from({length:r},(d,m)=>{const $=i.add(m,"month");return{name:$.format("YYYY-MM"),range:[$,$.endOf("month")]}});return{type:"month",times:x}},e=y(s.initialType),l=_(()=>e.value==="year"?n().times:e.value==="month"?t().times:[{name:"",range:[v(s.start),v(s.end)]}]),f=y(),h=p=>{var x;const i=v(p),r=[...l.value].reverse().findIndex(d=>i.isAfter(d.range[0]));return{index:r,time:(x=l.value[r])!=null?x:l.value[0]}},k=y(),w=y(v(s.start)),u=y(v(s.end)),g=()=>{const{index:p,time:i}=h(w.value);M(i,p,!1)};J(()=>{g()}),S(e,p=>{p!=="custom"&&te(()=>{g()})});const M=(p,i,r=!0)=>{var x;k.value=p,f.value&&((x=document.querySelector(`.slider-item-${i}`))==null||x.scrollIntoView({block:"center",inline:"center",behavior:r?"smooth":void 0})),a("change",...k.value.range)};return Q(()=>{w.value&&u.value&&a("change",w.value,u.value)}),(p,i)=>(C(),D("div",be,[c("div",Ye,[c("div",{class:V(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="year"}]),onClick:i[0]||(i[0]=r=>e.value="year")},Y(p.$t("year")),3),c("div",{class:V(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="month"}]),onClick:i[1]||(i[1]=r=>e.value="month")},Y(p.$t("month")),3),c("div",{class:V(["flex-1 flex justify-center m-1",{"bg-stone-400 rounded-full text-white":e.value==="custom"}]),onClick:i[2]||(i[2]=r=>e.value="custom")},Y(p.$t("custom")),3)]),e.value!=="custom"?(C(),D("div",{class:"slider w-full h-12 flex items-center overflow-x-scroll snap snap-always snap-mandatory snap-x",key:e.value,ref_key:"sliderEl",ref:f},[(C(!0),D(Z,null,H(b(l),(r,x)=>{var d;return C(),D("div",{key:r.name,class:V(["whitespace-nowrap mx-2 px-2 rounded-sm snap-center text-sm",[{"bg-stone-700 text-white":r.name===((d=k.value)==null?void 0:d.name)},`slider-item-${x}`]]),onClick:m=>M(r,x)},Y(r.name),11,De)}),128))])):(C(),D("div",Se,[T(L,{modelValue:w.value,"onUpdate:modelValue":i[3]||(i[3]=r=>w.value=r),"display-formatter":"YYYY-MM-DD",class:"text-sm buttoned rounded px-2"},null,8,["modelValue"]),Te,T(L,{modelValue:u.value,"onUpdate:modelValue":i[4]||(i[4]=r=>u.value=r),"display-formatter":"YYYY-MM-DD",class:"text-sm buttoned rounded px-2"},null,8,["modelValue"])]))]))}});const Ie=oe(Ve,[["__scopeId","data-v-b730748c"]]);me([pe,fe,ve,he,xe,ye,ge,_e,we,$e,ke]);const q=j({__name:"Chart",props:{option:null,onClick:null},emits:["click"],setup(o,{emit:a}){const s=o,n=y(),{width:t}=de();return J(()=>{const e=Ce(n.value);e.setOption(s.option),S(()=>s.option,()=>{e.setOption(s.option)}),se(()=>{e.dispose()}),S(t,()=>{e.resize()}),e.on("click",l=>{a("click",l)})}),(e,l)=>(C(),D("div",{ref_key:"chartRef",ref:n},null,512))}}),Ne=(o,a)=>{o.value=a.value;const s=S(()=>a.value.length,n=>{n>0&&(o.value=a.value,s())});S(()=>o.value,(n,t)=>{n.length===0&&(t.length===1?o.value=[t[0]]:o.value=[a.value[0]])})},N=o=>{let a=0;try{let t=Number(o).toString().toUpperCase();if(t.split("E").length===2){var s=!1;t.split(".").length===2&&(t=t.split(".")[1],parseInt(t.split("E")[0])!==0&&(s=!0));let e=t.split("E");s&&(a=e[0].length),a-=parseInt(e[1])}else t.split(".").length===2&&parseInt(t.split(".")[1])!==0&&(a=t.split(".")[1].length)}catch(n){throw n}finally{return(isNaN(a)||a<0)&&(a=0),a}},z=o=>{let a=Number(o),s=N(o),n=o.toString().toUpperCase();return n.split("E").length===2?a=Math.round(a*Math.pow(10,s)):a=Number(n.replace(".","")),a},G=(o,a,s,n)=>{let t=0;switch(o){case"add":t=a+s;break;case"sub":t=a-s;break;case"div":t=a/s;break;case"mul":t=a*s;break}return Math.abs(n-t)>1?t:n},F=(o,a)=>{const s=Number(o),n=Number(a);var t=0,e=s.toString(),l=n.toString();try{t+=N(e)}catch{}try{t+=N(l)}catch{}var f=z(e)*z(l)/Math.pow(10,t);return G("mul",s,n,f)},I=(o,a)=>{const s=Number(o),n=Number(a);let t,e,l;try{t=N(s)+1}catch{t=0}try{e=N(n)+1}catch{e=0}l=Math.pow(10,Math.max(t,e));var f=(F(s,l)+F(n,l))/l;return G("add",s,n,f)},{list:Ee}=W(),je=["income","expenses","sum"],Re=(o,a)=>{const s=_(()=>Ee.value.filter(t=>le(t,o.value,a.value)));return _(()=>{const t=new Map;return s.value.forEach(e=>{var w,u;const l=v.unix(e.time).format("YYYY-MM-DD"),f=(()=>(t.has(e.creatorId)||t.set(e.creatorId,{expenses:new Map,income:new Map,sum:new Map,incomeCategories:new Map,expenseCategories:new Map}),t.get(e.creatorId)))(),h=e.type===E.Expenses?f.expenses:f.income;h.set(l,I((w=h.get(l))!=null?w:0,e.money));const k=e.type===E.Expenses?f.expenseCategories:f.incomeCategories;k.set(e.categoryId,I((u=k.get(e.categoryId))!=null?u:0,e.money))}),t})},U=(o,a,s)=>{const n=a.filter(e=>o.has(e.id)).map(e=>{switch(s){case"expenses":return o.get(e.id).expenseCategories;case"income":return o.get(e.id).incomeCategories;case"sum":return[o.get(e.id).expenseCategories,o.get(e.id).incomeCategories];default:return o.get(e.id).expenseCategories}}).flat();return[...re(...n).entries()].map(([e,l])=>{const f=ie(e);return{total:l,name:f.name,category:ce(f.name)}})},Oe=(o,a,s)=>{const n=a.filter(l=>o.has(l.id)).map(l=>o.get(l.id)),t=[...new Set(n.map(l=>[...l[s].keys()]).flat())],e=n.map(l=>[...l[s].values()]);return{dates:t,values:e}},Ue={class:"w-full flex flex-col items-center"},Ae={class:"flex items-center shadow-inner rounded-full p-1"},Be=c("div",{class:"transform translate-y-[-30%]"},[c("i",{class:"icon-chart icon-xs"})],-1),Le=[Be],Pe={class:"flex items-center"},qe={class:"shadow buttoned px-4 max-w-[160px] rounded-full h-full truncate mx-2 py-1 flex items-center"},ze=c("i",{class:"icon-smile-no-mouth icon-xs"},null,-1),Fe={class:"px-2"},Je={class:"rounded buttoned h-full truncate flex items-center px-2"},We=c("div",{class:"pr-2"},[c("i",{class:"icon-arrows-exchange-alt-v icon-xs"})],-1),Ge=j({__name:"IncomeChart",props:{statistic:null},setup(o,{expose:a}){const s=o,n=y("expenses"),t=y([]),{allUsers:e}=ue();Ne(t,e);const l=y("pie"),f=_(()=>U(s.statistic,t.value,"expenses")),h=_(()=>U(s.statistic,t.value,"income")),k=_(()=>U(s.statistic,t.value,"sum")),w=_(()=>({expenses:f.value.reduce((d,m)=>I(d,m.total),0),income:h.value.reduce((d,m)=>I(d,m.total),0),sum:k.value.reduce((d,m)=>I(d,m.total),0)})),u=_(()=>{switch(n.value){case"expenses":return f.value;case"income":return h.value;case"sum":return k.value;default:return[]}}),g=y(""),M=y(""),p=d=>{d.data&&(g.value=`${d.data.category}: ${d.data.total}`,M.value=d.data.category)};S(n,()=>{g.value="",M.value=""}),a({currentCategory:M,currentType:n,selectedUsers:t});const i=_(()=>({title:{text:g.value,left:"center",top:"center"},dataset:{dimensions:["category","total"],source:ne(u.value)},xAxis:{type:"category",show:!1},yAxis:{},series:[{type:"pie",radius:["50%","70%"],stillShowZeroSum:!1}]})),r=_(()=>Oe(s.statistic,e.value,n.value)),x=_(()=>({xAxis:{type:"time",data:r.value.dates},yAxis:{type:"value"},series:r.value.values.map(m=>({data:m,type:"line",stack:"x"}))}));return(d,m)=>(C(),D("div",Ue,[c("div",Ae,[c("div",{class:V(["flex justify-center items-center w-12 h-6 rounded-full",{"bg-stone-700 text-white":l.value==="pie"}]),onClick:m[0]||(m[0]=$=>l.value="pie")},Le,2)]),(C(),R(ae,null,[l.value==="pie"?(C(),R(q,{key:0,class:"w-full aspect-square max-h-300px",option:b(i),onClick:p},null,8,["option"])):(C(),R(q,{key:1,class:"w-full aspect-square max-h-300px",option:b(x)},null,8,["option"]))],1024)),c("div",Pe,[T(P,{modelValue:t.value,"onUpdate:modelValue":m[1]||(m[1]=$=>t.value=$),list:b(e),multiple:"","value-key":"id",placement:"bottom-left"},{default:O(({allSelected:$})=>[c("div",qe,[ze,c("div",Fe,Y($?d.$t("all"):t.value.length===0?"None":t.value.map(B=>B.name).join(",")),1)])]),_:1},8,["modelValue","list"]),T(P,{modelValue:n.value,"onUpdate:modelValue":m[2]||(m[2]=$=>n.value=$),list:b(je)},{option:O(({item:$})=>[A(Y(d.$t($)),1)]),default:O(()=>[c("div",Je,[We,A(" "+Y(d.$t(n.value))+": ",1)])]),_:1},8,["modelValue","list"]),c("div",null,Y(b(w)[n.value]),1)])]))}}),Ke={class:"w-full h-full flex justify-center"},Qe={class:"h-full w-full mx-2 max-w-[600px] flex flex-col"},Ze={class:"filter w-full m-1 p-2"},He={class:"flex p-2 justify-end items-center"},Xe=c("div",{class:"flex items-center justify-center"},[c("i",{class:"icon-chevron-right"})],-1),ft=j({__name:"StatView",setup(o){const{list:a}=W(),s=_(()=>{const u=a.value.at(-1);if(u)return v.unix(u.time)}),n=_(()=>{const u=a.value.at(0);if(u)return v.unix(u.time)}),t=y(),e=y(),l=(u,g)=>{t.value=u,e.value=g},f=Re(t,e),h=y(),k=K(),w=()=>{var p;const{selectedUsers:u,currentType:g,currentCategory:M}=(p=h.value)!=null?p:{};k.push({name:"search",query:{filters:JSON.stringify({type:g==="expenses"?E.Expenses:g==="income"?E.Income:void 0,users:u==null?void 0:u.map(i=>i.id),categories:M?[M]:void 0,start:t.value,end:e.value})}})};return(u,g)=>(C(),D("div",Ke,[c("div",Qe,[c("div",Ze,[T(Ie,{start:b(s),end:b(n),onChange:l},null,8,["start","end"])]),c("div",null,[T(Ge,{ref_key:"chartRef",ref:h,statistic:b(f)},null,8,["statistic"])]),c("div",He,[c("div",{class:"flex buttoned rounded-full py-1 px-2 flex items-center",onClick:w},[A(Y(u.$t("see-details"))+" ",1),Xe])])])]))}});export{ft as default};
